# Screening call {-}

## Collection protocol {-}

Details about the data collection [protocol for participant screening and recruiting](https://www.play-project.org/collection.html#Participant_Recruitment) can be found on the [PLAY Project website](https://play-project.org).

To make the workflow more robust and reproducible, much of the work is embedded in functions (`R/functions.R`) extensive use is made of the `targets` package. As a result, the code chunks below are _not_executed, but are shown to make the logic of the workflow transparent.

## Retrieve files from KoBoToolbox {-}

The relevant KoBoToolbox data files have 'Demographic Questionnaire' in the title.

```{r list-kobo-forms, eval=FALSE}
kb_df <- list_kobo_data()

# Restrict to surveys collected at home
kb_demog <- kb_df %>%
  dplyr::filter(., stringr::str_detect(title, "Demographic"))

if ((dim(kb_demog)[1] < 1) || (!is.data.frame(kb_demog))) {
  stop("Error in selecting demographics surveys from KoBoToolbox.")
}
```

### Save selected raw files to local directory {-}

Prepare to retrieve all demographic data files.

```{r}
if (!dir.exists('data/xlsx/screening')) {
  stop("Directory not found: 'data/xlsx/screening'")
}
n_files <- dim(kb_demog)[1]
```

```{r download-demog, results = FALSE}
if (params$screening_download) {
purrr::map(1:n_files, retrieve_save_xls_export, kb_df = kb_demog, save_dir = "data/xlsx/screening")  
} else {
  message("'params$screening_download' is FALSE. KBT files not downloaded.")
}
```

## Convert to CSVs {-}

By default, we presume that we want to convert **all** of the XLSX files in `data/xlxs/screening` to CSVs.

While not strictly necessary, we filter the downloaded filename to ensure that it includes 'Demographic_Questionnaire'.

```{r, eval=FALSE}
load_xlsx_save_csv <- function(fl, out_dir) {
  require(tools)
  xl <- readxl::read_xlsx(fl)
  fn_csv <- file.path(out_dir, paste0(file_path_sans_ext(basename(fl)), ".csv"))
  if (dir.exists(dirname(fn_csv))) {
    readr::write_csv(xl, fn_csv)
    message("File saved: '", fn_csv, "'")
  } else {
    warning("Directory not found: '", dirname(fn_csv), "'")
  }
}

load_screening_xlsx_save_csv <- function(in_dir, out_dir) {
  require(purrr)
  demog_fns <- list.files(file.path(in_dir), 
                          pattern = "Demographic_Questionnaire", full.names = TRUE)
  purrr::map(demog_fns, load_xlsx_save_csv, out_dir)
}
```

```{r, eval=FALSE}
load_screening_xlsx_save_csv("data/xlsx/screening", "data/csv/screening")
```

## Merge files {-}

### Compare the files {-}

Before merging, we have to examine how the fields compare.

```{r}
csv_fns <- list.files("data/csv/screening", pattern = "\\.csv", full.names = TRUE)
```

Open the first file: '`r basename(csv_fns[1])`'.

```{r}
demog_1 <- readr::read_csv(csv_fns[1], show_col_types = FALSE)
```

There are $n=$ `r dim(demog_1)[1]` data records and $n=$ `r dim(demog_1)[2]` fields.

Open the second file: '`r basename(csv_fns[2])`'.

```{r}
demog_2 <- readr::read_csv(csv_fns[2], show_col_types = FALSE)
```

There are $n=$ `r dim(demog_2)[1]` data records and $n=$ `r dim(demog_2)[2]` fields.

Open the third file: '`r basename(csv_fns[3])`'.

```{r}
demog_3 <- readr::read_csv(csv_fns[3], show_col_types = FALSE)
```

There are $n=$ `r dim(demog_3)[1]` data records and $n=$ `r dim(demog_3)[2]` fields.

::: {.rmdnote}
These files have different numbers of columns, so we need to be careful in creating a merged data file.
:::

### Extract column names {-}

```{r}
demog_1_names <- names(demog_1)
demog_2_names <- names(demog_2)
demog_3_names <- names(demog_3)
```

Compare 1 to 2.

```{r}
sum(demog_1_names == demog_2_names)
```

Compare 1 to 3.

```{r}
sum(demog_1_names == demog_3_names)
```

Compare 2 to 3.

```{r}
sum(demog_2_names == demog_3_names)
```

The second and third data files have the most overlap.

### Extract core variables {-}

Since only some of these data come from enrolled participants, we have to be careful about what variables we extract for project management purposes.

As of `r Sys.Date()`, the variables indicated in the cleaning functions below are selected and exported.

::: {.rmdnote}
This scheme is not elegant and is brittle. It should be improved.
:::

```{r, eval=FALSE}
clean_demog_1 <- function(csv_fn_1) {
  df_1 <- readr::read_csv(csv_fn_1, show_col_types = FALSE)
  df_1 %>%
    dplyr::select(
      .,
      submit_date = c_today,
      site_id = `play_phone_questionnaire/group_siteinfo/site_id`,
      sub_num = `play_phone_questionnaire/group_siteinfo/subject_number`,
      child_age_mos = `play_phone_questionnaire/check_childage`,
      child_sex = `play_phone_questionnaire/child_sex`,
      language_to_child = `play_phone_questionnaire/language_spoken_child`,
      language_spoken_home = `play_phone_questionnaire/language_spoken_home`,
      child_bornonduedate = `play_phone_questionnaire/child_information/child_onterm`,
      child_weight_pounds = `play_phone_questionnaire/child_information/child_weight_pounds`,
      child_weight_ounces = `play_phone_questionnaire/child_information/child_weight_ounces`,
      child_birth_complications = `play_phone_questionnaire/child_information/child_birth_complications`,
      major_illnesses_injuries = `play_phone_questionnaire/child_information/major_illnesses_injuries`,
      child_sleep_time = `play_phone_questionnaire/child_information/child_sleep_time`,
      child_wake_time = `play_phone_questionnaire/child_information/child_wake_time`,
      child_nap_hours = `play_phone_questionnaire/child_information/child_nap_hours`,
      child_sleep_location = `play_phone_questionnaire/child_information/child_sleep_location`,
      mother_childbirth_age = `play_phone_questionnaire/parent_information/mother_information/mother_childbirth_age`,
      mother_race = `play_phone_questionnaire/parent_information/mother_information/mother_race`,
      mother_ethnicity = `play_phone_questionnaire/parent_information/mother_information/mother_ethnicity`,
    ) %>%
    dplyr::mutate(
      .,
      site_id = dplyr::recode(
        site_id,
        NYU = "NYUNI",
        new_york_unive = "NYUNI",
        georgetown_uni = "GEORG",
        GTN = "GEORG",
        UCR = "UCRIV"
      )
    ) %>%
    dplyr::filter(., !stringr::str_detect(site_id, '_of__'))
}
```

```{r, eval=FALSE}
clean_demog_2 <- function(csv_fn_2) {
  df_2 <- readr::read_csv(csv_fn_2, show_col_types = FALSE)
  df_2 %>%
    dplyr::select(
      submit_date = c_today,
      site_id = `play_demo_questionnaire/group_siteinfo/site_id`,
      sub_num = `play_demo_questionnaire/group_siteinfo/subject_number`,
      child_age_mos = `play_demo_questionnaire/check_childage`,
      child_sex = `play_demo_questionnaire/child_sex`,
      language_to_child = `play_demo_questionnaire/language_spoken_child`,
      language_spoken_home = `play_demo_questionnaire/language_spoken_house`,
      child_bornonduedate = `play_demo_questionnaire/child_information/child_onterm`,
      child_weight_pounds = `play_demo_questionnaire/child_information/child_weight_pounds`,
      child_weight_ounces = `play_demo_questionnaire/child_information/child_weight_ounces`,
      child_birth_complications = `play_demo_questionnaire/child_information/child_birth_complications`,
      major_illnesses_injuries = `play_demo_questionnaire/child_information/major_illnesses_injuries`,
      child_sleep_time = `play_demo_questionnaire/child_information/child_sleep_time`,
      child_wake_time = `play_demo_questionnaire/child_information/child_wake_time`,
      child_nap_hours = `play_demo_questionnaire/child_information/child_nap_hours`,
      child_sleep_location = `play_demo_questionnaire/child_information/child_sleep_location`,
      mother_childbirth_age = `play_demo_questionnaire/group_mominfo/mom_childbirth_age`,
      mother_race = `play_demo_questionnaire/group_mominfo/mom_race`,
      mother_ethnicity = `play_demo_questionnaire/group_mominfo/mom_ethnicity`,
    )
}
```

### Merge files {-}

```{r, eval=FALSE}

clean_merge_demog <- function(fns) {
  rbind(clean_demog_1(fns[1]), 
        clean_demog_2(fns[2]), 
        clean_demog_2(fns[3])) %>%
    dplyr::arrange(., submit_date)
}
```

Add cumulative `n_calls` variable.

```{r}
demog_submissions <- demog_submissions %>%
  dplyr::arrange(., submit_date) %>%
  dplyr::mutate(., n_calls = seq_along(submit_date))
```

## Plots {-}

Plot the time series of recruiting/screening calls.

```{r, fig.cap="Time series of recruiting/screening calls."}
demog_submissions %>%
  ggplot(.) +
  aes(submit_date, n_calls, color = site_id) +
  geom_point()
```

Plot the number of calls made by site.

```{r, fig.cap="Recruiting calls by site"}
demog_submissions %>%
  ggplot(.) +
  aes(site_id, fill = site_id) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) # Rotate text
```

