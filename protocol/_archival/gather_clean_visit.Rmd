---
title: "Gather Clean Visit"
subtitle: "Version `r Sys.time()`"
author: Rick Gilmore
output: 
  html_document:
    code_folding: hide
    self_contained: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
---

# Purpose

This document documents and implements downloading and cleaning the questionnaires for the PLAY Project data from the KoBoToolbox server.

There are different data files for each home visit because of the need for different instructions and questions depending on the participant age group and language environment.

# Setup

The PLAY Project uses KoBoToolbox to collect data from parents and researchers using a tablet application.

The data are stored in an account on <https://kf.kobotoolbox.org>. The login credentials for that account are shared among the PLAY Project staff.

To access the site's API programmatically, an API key was downloaded and added to the local `~/.Renviron` file.

To test whether the local system has the API key installed, run the following command `Sys.getenv("KOBO_API_KEY")`.

With the API key installed, several custom functions in `R/kobo_export.R` can be run.

## Load/source helper functions

```{r}
source("R/kobo_export.R")
```

## Install dependencies

The helper functions require several external packages. To confirm that these are installed, run the following chunk.

```{r}
install_kobo_packages()
```

## Confirm connection to KoBoToolbox server

We now confirm that we can access data from the server.

```{r}
kb_df <- list_kobo_data()

str(kb_df)
```

This function returns data frame that information about *all* of the forms we have created thus far.

## Filtering the Home Questionnaires

Let's filter these to focus on the home questionnaires.

```{r}
kb_home <- kb_df %>%
  dplyr::filter(., stringr::str_detect(title, "Home"))

kb_home  
```

There are 22 of these.

# Importing 2021 data

Let's further filter to focus on those with 2021 dates.

```{r}
kb_home_2021 <- kb_home %>%
  dplyr::filter(., stringr::str_detect(title, "2021"))

kb_home_2021
```

There are 9 of these. That seems like the right number since there are 3/age group.

We want to see how similar these are, so let's export from KB all 9.
 
```{r}
purrr::map(1:dim(kb_home_2021)[1], retrieve_save_xls_export, kb_home_2021)
```

## 12-mo-olds (2021 versions)

We'll use the `readxl` package to load the three versions for 12-month-olds from the locally saved XLSX file.

```{r}
home_12_eng <- readxl::read_excel("tmp/740625_PLAY_HomeQuestionaires_12_English-2021-07-29.xlsx")
home_12_biling_eng <- readxl::read_excel("tmp/740623_PLAY_HomeQuestionaires_12_Bilingual_English-2021-07-29.xlsx")
home_12_biling_span <- readxl::read_excel("tmp/740624_PLAY_HomeQuestionaires_12_Bilingual_Spanish-2021-07-29.xlsx")
```

Let's list just the questions asked.

```{r}
dim(home_12_eng)
dim(home_12_biling_eng)
dim(home_12_biling_span)
```

The good news is that the two bilingual data forms have the same number of columns even though there is no data for them.

Also good news is the fact that we can filter on `mcdi` to select those questions. Let's do that next.

```{r}
contains_mcdi_12 <- stringr::str_detect(names(home_12_eng), 'mcdi')
contains_mcdi_12_biling_eng <- stringr::str_detect(names(home_12_biling_eng), 'mcdi')
contains_mcdi_12_biling_span <- stringr::str_detect(names(home_12_biling_span), 'mcdi')

sum(contains_mcdi_12)
sum(contains_mcdi_12_biling_eng)
sum(contains_mcdi_12_biling_span)
```

Ok, so now we can select variables that do or do not contain 'mcdi' and save those separately.

We'll first define a helper function.

```{r}
extract_save_mcdi <- function(df, fn, save_file = FALSE) {
  play_id_col <- (1:length(names(df)))[stringr::str_detect(names(df), 'participant_id')]
  
  mcdi_qs <- stringr::str_detect(names(df), 'mcdi')
  mcdi_cols <- (1:length(names(df)))[mcdi_qs]
    
  mcdi <- df %>%
    dplyr::select(., all_of(play_id_col), all_of(mcdi_cols))    
  
  if (save_file) readr::write_csv(mcdi, fn)
  
  mcdi
}

extract_mcdi_col_names <- function(df) {
  mcdi_qs <- stringr::str_detect(names(df), 'mcdi')
  mcdi_cols <- (1:length(names(df)))[mcdi_qs]
    
  names(df)[mcdi_cols]
}
```

Then let's test it.

```{r}
extract_save_mcdi(home_12_eng, 'tmp/mbcdi_12_eng_2021.csv')
extract_save_mcdi(home_12_biling_eng, 'tmp/mbcdi_12_biling_eng_2021.csv')
extract_save_mcdi(home_12_biling_span, 'tmp/mbcdi_12_biling_span_2021.csv')
```

So the MBCDI is going to require additional cleaning beyond the `rename_with(., basename)`.

Let's try extracting these data to see if the other variables line up.

**NOTE**: I made column renaming using the `basename()` function an option with `FALSE` as the default.

Since the non-MBCDI data contain identifiers, we should extract those.

```{r}
remove_identifiers <- function(df) {
  contains_name <- stringr::str_detect(names(df), 'name')
  contains_address <- stringr::str_detect(names(df), 'address')
  contains_phone <- stringr::str_detect(names(df), 'phone')
  contains_email <- stringr::str_detect(names(df), 'email')
  contains_birthdate <- stringr::str_detect(names(df), 'birthdate')
  contains_first <- stringr::str_detect(names(df), 'first[12]?')
  contains_last <- stringr::str_detect(names(df), 'last[12]?')
  contains_city <- stringr::str_detect(names(df), 'city')
  contains_year <- stringr::str_detect(names(df), 'year[12]?')
  contains_month <- stringr::str_detect(names(df), 'month[12]?')
  contains_day <- stringr::str_detect(names(df), 'day[12]?')
  
  identifiable_data <- contains_name | contains_address | 
    contains_phone | contains_email | contains_birthdate | contains_first |
    contains_last | contains_city | contains_year | contains_month | contains_day
  
  identifiable_cols <- (1:length(names(df)))[identifiable_data]
  
  df_deidentified <- df %>%
    dplyr::select(., -all_of(identifiable_cols))
  
  df_deidentified
}
```

```{r}
extract_non_mbcdi <- function(df, rename_cols = FALSE) {
  
  df <- remove_identifiers(df)
  
  play_id_col <- (1:length(names(df)))[stringr::str_detect(names(df), 'participant_id')]
  
  # Select non-mcdi cols
  mcdi_qs <- stringr::str_detect(names(df), 'mcdi')
  non_mcdi_qs <- not(mcdi_qs)
  non_mcdi_cols <- (1:length(names(df)))[non_mcdi_qs]
    
  non_mcdi <- df %>%
    dplyr::select(., all_of(play_id_col), all_of(non_mcdi_cols))
  
  if (rename_cols) {
    non_mcdi <- dplyr::rename_with(non_mcdi, basename)
  }
  
  non_mcdi
}

extract_save_non_mbcdi <- function(df, fn, rename_cols = FALSE) {
  non_mcdi <- extract_non_mbcdi(df, rename_cols)
  readr::write_csv(non_mcdi, fn)
  message('Saved ', fn)
}
```

```{r}
eng_clean_12 <- extract_non_mbcdi(home_12_eng)
biling_eng_clean_12 <- extract_non_mbcdi(home_12_biling_eng)
biling_span_clean_12 <- extract_non_mbcdi(home_12_biling_span)
```


```{r}
extract_save_non_mbcdi(home_12_eng, 'tmp/non_mbcdi_12_eng_2021.csv')
extract_save_non_mbcdi(home_12_biling_eng, 'tmp/non_mbcdi_12_biling_eng_2021.csv')
extract_save_non_mbcdi(home_12_biling_span, 'tmp/non_mbcdi_12_biling_span_2021.csv')
```

Let's reimport and check column names.

```{r}
qs_12_eng_2021 <- readr::read_csv('tmp/non_mbcdi_12_eng_2021.csv')
qs_12_biling_eng_2021 <- readr::read_csv('tmp/non_mbcdi_12_biling_eng_2021.csv')
qs_12_biling_span_2021 <- readr::read_csv('tmp/non_mbcdi_12_biling_span_2021.csv')
```

```{r}
dim(qs_12_eng_2021)
dim(qs_12_biling_eng_2021)
dim(qs_12_biling_span_2021)

names(qs_12_biling_eng_2021) == names(qs_12_biling_span_2021)
```

So, there is an additional variable in the 'English' file, but the two 'bilingual' files are equivalent at the variable-name level.

## 18-mo-olds (2021 versions)

```{r}
home_18_eng <- readxl::read_excel("tmp/740628_PLAY_HomeQuestionnaires_18_English-2021-07-29.xlsx")
home_18_biling_eng <- readxl::read_excel("tmp/740626_PLAY_HomeQuestionaires_18_Bilingual_English-2021-07-29.xlsx")
home_18_biling_span <- readxl::read_excel("tmp/740627_PLAY_HomeQuestionaires_18_Bilingual_Spanish-2021-07-29.xlsx")
```

Let's list just the questions asked.

```{r}
dim(home_18_eng)
dim(home_18_biling_eng)
dim(home_18_biling_span)
```

```{r}
contains_mcdi_18 <- stringr::str_detect(names(home_18_eng), 'mcdi')
contains_mcdi_18_biling_eng <- stringr::str_detect(names(home_18_biling_eng), 'mcdi')
contains_mcdi_18_biling_span <- stringr::str_detect(names(home_18_biling_span), 'mcdi')

sum(contains_mcdi_18)
sum(contains_mcdi_18_biling_eng)
sum(contains_mcdi_18_biling_span)
```

These counts look similar to the 12-mo-olds, so that's good.

Let's extract the MBCDI data.

```{r}
extract_save_mcdi(home_18_eng, 'tmp/mbcdi_18_eng_2021.csv')
extract_save_mcdi(home_18_biling_eng, 'tmp/mbcdi_18_biling_eng_2021.csv')
extract_save_mcdi(home_18_biling_span, 'tmp/mbcdi_18_biling_span_2021.csv')
```

Then extract (cleaning identifiable vars) the non-MBCDI-data.

```{r}
extract_save_non_mbcdi(home_18_eng, 'tmp/non_mbcdi_18_eng_2021.csv')
extract_save_non_mbcdi(home_18_biling_eng, 'tmp/non_mbcdi_18_biling_eng_2021.csv')
extract_save_non_mbcdi(home_18_biling_span, 'tmp/non_mbcdi_18_biling_span_2021.csv')
```

Let's reimport and check column names.

```{r}
qs_18_eng_2021 <- readr::read_csv('tmp/non_mbcdi_18_eng_2021.csv')
qs_18_biling_eng_2021 <- readr::read_csv('tmp/non_mbcdi_18_biling_eng_2021.csv')
qs_18_biling_span_2021 <- readr::read_csv('tmp/non_mbcdi_18_biling_span_2021.csv')
```

```{r}
dim(qs_18_eng_2021)
dim(qs_18_biling_eng_2021)
dim(qs_18_biling_span_2021)

questions_equal <- function(df_a, df_b) {
  names_a <- names(df_a)
  names_b <- names(df_b)
  
  equal_length <- (length(names_a) == length(names_b))
  
  if (equal_length) {
    message(paste0("Lengths are equal: ", length(names_a)))
    qs_equal <- names_a == names_b
    if (sum(qs_equal) == length(names_a)) {
      message("Qs are identical")
    } else {
      message("Qs differ")
      qs_equal
    }
  } else {
    message("Lengths differ: ", length(names_a), " vs. ", length(names_b))
    shorter_length <- min(length(names_a), length(names_b))
    names_a[1:shorter_length] == names_b[1:shorter_length]
  }
}

questions_equal(qs_18_eng_2021, qs_18_biling_eng_2021)
questions_equal(qs_18_biling_eng_2021, qs_12_biling_span_2021)
```

## 24-mo-olds (2021 versions)

```{r}
home_24_eng <- readxl::read_excel("tmp/740629_PLAY_HomeQuestionnaires_24_English-2021-07-30.xlsx")
home_24_biling_eng <- readxl::read_excel("tmp/740627_PLAY_HomeQuestionaires_18_Bilingual_Spanish-2021-07-29.xlsx")
home_24_biling_span <- readxl::read_excel("tmp/740630_PLAY_HomeQuestionaires_24_Bilingual_Spanish-2021-07-30.xlsx")
```

Let's list just the questions asked.

```{r}
dim(home_24_eng)
dim(home_24_biling_eng)
dim(home_24_biling_span)
```

```{r}
contains_mcdi_24 <- stringr::str_detect(names(home_24_eng), 'mcdi')
contains_mcdi_24_biling_eng <- stringr::str_detect(names(home_24_biling_eng), 'mcdi')
contains_mcdi_24_biling_span <- stringr::str_detect(names(home_24_biling_span), 'mcdi')

sum(contains_mcdi_24)
sum(contains_mcdi_24_biling_eng)
sum(contains_mcdi_24_biling_span)
```

Let's extract the MBCDI data.

```{r}
extract_save_mcdi(home_24_eng, 'tmp/mbcdi_24_eng_2021.csv')
extract_save_mcdi(home_24_biling_eng, 'tmp/mbcdi_24_biling_eng_2021.csv')
extract_save_mcdi(home_24_biling_span, 'tmp/mbcdi_24_biling_span_2021.csv')
```

Then extract (cleaning identifiable vars) the non-MBCDI-data.

```{r}
extract_save_non_mbcdi(home_24_eng, 'tmp/non_mbcdi_24_eng_2021.csv')
extract_save_non_mbcdi(home_24_biling_eng, 'tmp/non_mbcdi_24_biling_eng_2021.csv')
extract_save_non_mbcdi(home_24_biling_span, 'tmp/non_mbcdi_24_biling_span_2021.csv')
```

Let's reimport and check column names.

```{r}
qs_24_eng_2021 <- readr::read_csv('tmp/non_mbcdi_24_eng_2021.csv')
qs_24_biling_eng_2021 <- readr::read_csv('tmp/non_mbcdi_24_biling_eng_2021.csv')
qs_24_biling_span_2021 <- readr::read_csv('tmp/non_mbcdi_24_biling_span_2021.csv')
```

```{r}
dim(qs_24_eng_2021)
dim(qs_24_biling_eng_2021)
dim(qs_24_biling_span_2021)

questions_equal(qs_24_eng_2021, qs_24_biling_eng_2021)
questions_equal(qs_24_biling_eng_2021, qs_12_biling_span_2021)
```

## Provisional summary of 2021 version exploration

- The non-MBCDI data look very similar across 8 of the 9 forms.
- The 12-mo-old English speaking family data have an additional column.

Let's check to see if the questions (column names) are equal across age groups.

```{r}
questions_equal(qs_12_biling_eng_2021, qs_12_biling_eng_2021)

questions_equal(qs_12_biling_eng_2021, qs_18_biling_eng_2021)
questions_equal(qs_12_biling_span_2021, qs_18_biling_span_2021)

questions_equal(qs_18_biling_eng_2021, qs_24_biling_eng_2021)

questions_equal(qs_12_biling_span_2021, qs_18_biling_span_2021)
questions_equal(qs_18_eng_2021, qs_24_eng_2021)
```

So, other than the 12-mo-old English anomaly, we can combine the 2021 versions of the non-MBCDI data into a single dataset.

# Importing 2020 data

```{r}
kb_home_2020 <- kb_home %>%
  dplyr::filter(., stringr::str_detect(title, "2020"))

kb_home_2020
```
Yay, there are 9! Let's save these locally.

```{r}
purrr::map(1:dim(kb_home_2020)[1], retrieve_save_xls_export, kb_home_2020)
```

## 12-mo-olds (2020 versions)

```{r}
home_12_eng <- readxl::read_excel("tmp/363431_PLAY_Home_Questionnaires_-_12_English_2020-03-04.xlsx")
home_12_biling_eng <- readxl::read_excel("tmp/411456_PLAY_Home_Questionaires_-_12_Bilingual_English_2020-03-04.xlsx")
home_12_biling_span <- readxl::read_excel("tmp/411469_PLAY_Home_Questionnaires_-_12_Bilingual_Spanish_2020-03-04.xlsx")
```

Let's list just the questions asked.

```{r}
dim(home_12_eng)
dim(home_12_biling_eng)
dim(home_12_biling_span)
```

The good news is that the two bilingual data forms have the same number of columns even though there is no data for them.

Also good news is the fact that we can filter on `mcdi` to select those questions. Let's do that next.

```{r}
contains_mcdi_12 <- stringr::str_detect(names(home_12_eng), 'mcdi')
contains_mcdi_12_biling_eng <- stringr::str_detect(names(home_12_biling_eng), 'mcdi')
contains_mcdi_12_biling_span <- stringr::str_detect(names(home_12_biling_span), 'mcdi')

sum(contains_mcdi_12)
sum(contains_mcdi_12_biling_eng)
sum(contains_mcdi_12_biling_span)
```

```{r}
extract_save_mcdi(home_12_eng, 'tmp/mbcdi_12_eng_2020.csv')
extract_save_mcdi(home_12_biling_eng, 'tmp/mbcdi_12_biling_eng_2020.csv')
extract_save_mcdi(home_12_biling_span, 'tmp/mbcdi_12_biling_span_2020.csv')
```

```{r}
extract_save_non_mbcdi(home_12_eng, 'tmp/non_mbcdi_12_eng_2020.csv')
extract_save_non_mbcdi(home_12_biling_eng, 'tmp/non_mbcdi_12_biling_eng_2020.csv')
extract_save_non_mbcdi(home_12_biling_span, 'tmp/non_mbcdi_12_biling_span_2020.csv')
```

```{r}
qs_12_eng_2020 <- readr::read_csv('tmp/non_mbcdi_12_eng_2020.csv')
qs_12_biling_eng_2020 <- readr::read_csv('tmp/non_mbcdi_12_biling_eng_2020.csv')
qs_12_biling_span_2020 <- readr::read_csv('tmp/non_mbcdi_12_biling_span_2020.csv')
```

```{r}
questions_equal(qs_12_eng_2020, qs_12_biling_eng_2020)
questions_equal(qs_12_biling_eng_2020, qs_12_biling_span_2020)
```

So, misalignment occurs at the end of the questions near 298.



## 18-mo-olds (2020 versions)

```{r}
home_18_eng <- readxl::read_excel("tmp/363349_PLAY_Home_Questionnaires_-_18_English_2020-03-04.xlsx")
home_18_biling_eng <- readxl::read_excel("tmp/363466_PLAY_Home_Questionnaires_-_18_Bilingual_English_2020-03-04.xlsx")
home_18_biling_span <- readxl::read_excel("tmp/411388_PLAY_Home_Questionnaires_-_18_Bilingual_Spanish_2020-03-04.xlsx")
```

Let's list just the questions asked.

```{r}
dim(home_18_eng)
dim(home_18_biling_eng)
dim(home_18_biling_span)
```

The good news is that the two bilingual data forms have the same number of columns even though there is no data for them.

Also good news is the fact that we can filter on `mcdi` to select those questions. Let's do that next.

```{r}
contains_mcdi_18 <- stringr::str_detect(names(home_18_eng), 'mcdi')
contains_mcdi_18_biling_eng <- stringr::str_detect(names(home_18_biling_eng), 'mcdi')
contains_mcdi_18_biling_span <- stringr::str_detect(names(home_18_biling_span), 'mcdi')

sum(contains_mcdi_18)
sum(contains_mcdi_18_biling_eng)
sum(contains_mcdi_18_biling_span)
```

```{r}
extract_save_mcdi(home_18_eng, 'tmp/mbcdi_18_eng_2020.csv')
extract_save_mcdi(home_18_biling_eng, 'tmp/mbcdi_18_biling_eng_2020.csv')
extract_save_mcdi(home_18_biling_span, 'tmp/mbcdi_18_biling_span_2020.csv')
```

```{r}
extract_save_non_mbcdi(home_18_eng, 'tmp/non_mbcdi_18_eng_2020.csv')
extract_save_non_mbcdi(home_18_biling_eng, 'tmp/non_mbcdi_18_biling_eng_2020.csv')
extract_save_non_mbcdi(home_18_biling_span, 'tmp/non_mbcdi_18_biling_span_2020.csv')
```

```{r}
qs_18_eng_2020 <- readr::read_csv('tmp/non_mbcdi_18_eng_2020.csv')
qs_18_biling_eng_2020 <- readr::read_csv('tmp/non_mbcdi_18_biling_eng_2020.csv')
qs_18_biling_span_2020 <- readr::read_csv('tmp/non_mbcdi_18_biling_span_2020.csv')
```

```{r}
questions_equal(qs_18_eng_2020, qs_18_biling_eng_2020)
questions_equal(qs_18_biling_eng_2020, qs_18_biling_span_2020)
```




## 24-mo-olds (2020 versions)

```{r}
home_24_eng <- readxl::read_excel("tmp/363381_PLAY_Home_Questionnaires_-_24_English_2020-03-04.xlsx")
home_24_biling_eng <- readxl::read_excel("tmp/363465_PLAY_Home_Questionnaires_-_24_Bilingual_English_2020-03-04.xlsx")
home_24_biling_span <- readxl::read_excel("tmp/408149_PLAY_Home_Questionnaires_-_24_Bilingual_Spanish_2020-03-04.xlsx")
```

Let's list just the questions asked.

```{r}
dim(home_24_eng)
dim(home_24_biling_eng)
dim(home_24_biling_span)
```

The good news is that the two bilingual data forms have the same number of columns even though there is no data for them.

Also good news is the fact that we can filter on `mcdi` to select those questions. Let's do that next.

```{r}
contains_mcdi_24 <- stringr::str_detect(names(home_24_eng), 'mcdi')
contains_mcdi_24_biling_eng <- stringr::str_detect(names(home_24_biling_eng), 'mcdi')
contains_mcdi_24_biling_span <- stringr::str_detect(names(home_24_biling_span), 'mcdi')

sum(contains_mcdi_24)
sum(contains_mcdi_24_biling_eng)
sum(contains_mcdi_24_biling_span)
```

```{r}
extract_save_mcdi(home_24_eng, 'tmp/mbcdi_24_eng_2020.csv')
extract_save_mcdi(home_24_biling_eng, 'tmp/mbcdi_24_biling_eng_2020.csv')
extract_save_mcdi(home_24_biling_span, 'tmp/mbcdi_24_biling_span_2020.csv')
```

```{r}
extract_save_non_mbcdi(home_24_eng, 'tmp/non_mbcdi_24_eng_2020.csv')
extract_save_non_mbcdi(home_24_biling_eng, 'tmp/non_mbcdi_24_biling_eng_2020.csv')
extract_save_non_mbcdi(home_24_biling_span, 'tmp/non_mbcdi_24_biling_span_2020.csv')
```

```{r}
qs_24_eng_2020 <- readr::read_csv('tmp/non_mbcdi_24_eng_2020.csv')
qs_24_biling_eng_2020 <- readr::read_csv('tmp/non_mbcdi_24_biling_eng_2020.csv')
qs_24_biling_span_2020 <- readr::read_csv('tmp/non_mbcdi_24_biling_span_2020.csv')
```

```{r}
questions_equal(qs_24_eng_2020, qs_24_biling_eng_2020)
questions_equal(qs_24_biling_eng_2020, qs_24_biling_span_2020)
```

# Cross-checks

## Cross-checking among 2020 forms

### Bilingual English

```{r}
questions_equal(qs_12_biling_eng_2020, qs_18_biling_eng_2020)
questions_equal(qs_18_biling_eng_2020, qs_24_biling_eng_2020)
```

### Bilingual Spanish

```{r}
questions_equal(qs_12_biling_span_2020, qs_18_biling_span_2020)
questions_equal(qs_18_biling_span_2020, qs_24_biling_span_2020)
```

### English speakers only

```{r}
questions_equal(qs_12_eng_2020, qs_18_eng_2020)
questions_equal(qs_18_eng_2020, qs_24_eng_2020)
```

## Checking 2020 and 2021 forms across age by language groups

### English speakers only

```{r}
questions_equal(qs_12_eng_2020, qs_12_eng_2021)
questions_equal(qs_18_eng_2020, qs_18_eng_2021)
questions_equal(qs_24_eng_2020, qs_24_eng_2021)
```

### Bilingual English

```{r}
questions_equal(qs_12_biling_eng_2020, qs_12_biling_eng_2021)
questions_equal(qs_18_biling_eng_2020, qs_18_biling_eng_2021)
questions_equal(qs_24_biling_eng_2020, qs_24_biling_eng_2021)
```

### Bilingual Spanish

```{r}
questions_equal(qs_12_biling_span_2020, qs_12_biling_span_2021)
questions_equal(qs_18_biling_span_2020, qs_18_biling_span_2021)
questions_equal(qs_24_biling_span_2020, qs_24_biling_span_2021)
```

# Joining 2020 and 2021 forms

## English-speakers

```{r, eval = FALSE}
eng_12 <- dplyr::inner_join(qs_12_eng_2020, qs_12_eng_2021)
eng_18 <- dplyr::inner_join(qs_18_eng_2020, qs_18_eng_2021)
eng_24 <- dplyr::inner_join(qs_24_eng_2020, qs_24_eng_2021)

eng <- dplyr::inner_join(eng_12, eng_18)
eng <- dplyr::inner_join(eng, eng_24)
eng
```

So, this is going to be more work. Similar variables don't have the same type. 

## Clean after manual join

Because of quirks in how `readr::read_csv()` parsed the different forms, I merged the 2020 and 2021 forms for English speaking families manually. The combined file is `tmp/non_mbcdi_all_eng.csv`.

```{r}
n_valid_sessions <- function(age = '12', group = 'biling_span', year = '2020', fn = 'tmp/non_mbcdi_') {
  this_fn <- paste0(fn, age, '_', group, '_', year, '.csv')
  x <- readr::read_csv(this_fn, show_col_types = FALSE)
  message(paste0(this_fn, ' has ', dim(x)[1], ' rows.'))
}
```

```{r}
n_valid_sessions('12', 'biling_span', '2020')
n_valid_sessions('12', 'biling_span', '2021')
n_valid_sessions('18', 'biling_span', '2020')
n_valid_sessions('18', 'biling_span', '2021')
n_valid_sessions('24', 'biling_span', '2020')
n_valid_sessions('24', 'biling_span', '2021')
```

The (manually) merged `biling_span` files are in `non_mbcdi_all_biling_span.csv`.

```{r}
n_valid_sessions('12', 'biling_eng', '2020')
n_valid_sessions('12', 'biling_eng', '2021')
n_valid_sessions('18', 'biling_eng', '2020')
n_valid_sessions('18', 'biling_eng', '2021')
n_valid_sessions('24', 'biling_eng', '2020')
n_valid_sessions('24', 'biling_eng', '2021')

```

The (manually) merged `biling_eng` files are in `non_mbcdi_all_biling_eng.csv`.

The (manually) merged `biling` files are in `non_mbcdi_all_biling.csv`.

Shall we try joining these?

```{r}
eng <- readr::read_csv('tmp/non_mbcdi_all_eng.csv', show_col_types = FALSE)
biling <- readr::read_csv('tmp/non_mbcdi_all_biling.csv', show_col_types = FALSE)
```

Ok, that didn't work.

```{r}
length(names(eng))
length(names(biling))

eng_vars <- names(eng)
biling_vars <- names(biling)

eng_vars == biling_vars
```

At this point, I think I should consolidate the operations above into a set of functions and then try merging the 2021 and 2020 forms separately.

## Creating 2021 merge

First, let's consolidate the workflow.

```{r}
# List KoBo data
kb_df <- list_kobo_data()

# Download and save updated XLSX files for specific questionnaire, here the home questionnaires
kb_home <- kb_df %>%
  dplyr::filter(., stringr::str_detect(title, "[Hh]ome"),
                stringr::str_detect(title, "202[01]"))

purrr::map(1:dim(kb_home)[1], retrieve_save_xls_export, kb_home)
```

```{r}
# Select 2021 data and for all 9 XLSX files
# Import, clean identifiers, extract non-MBCDI data, and save as CSV

find_xlsx_file <- function(form_year = '2021',
                           age_group = '12',
                           lang_grp = 'English',
                           file_dir = 'tmp') {
  search_pattern <-
    paste0(age_group, '_', lang_grp, '.*', form_year, '.*\\.xlsx$')
  list.files(file_dir, search_pattern, full.names = TRUE)
}

import_play_xlsx <- function(form_year = '2021',
                             age_group = '12',
                             lang_grp = 'English',
                             file_dir = 'tmp') {
  this_file <-
    find_xlsx_file(form_year, age_group, lang_grp, file_dir)
  
  if (!is.null(this_file)) {
    readxl::read_excel(this_file)
  } else {
    message('File not found: ', file.path(this_file))
  }
}

import_xlsx_clean_save_non_mbcdi <- function(form_year = '2021',
                                             age_group = '12',
                                             lang_grp = 'English',
                                             file_dir = 'tmp',
                                             vb = TRUE) {
  
  require(import_play_xlsx)
  
  if (vb) message('Importing data for ', paste0(form_year, '_', age_group, '_', lang_grp))
  df <- import_play_xlsx(form_year, age_group, lang_grp, file_dir)
  
  if (!is.null(df)) {
    extract_save_non_mbcdi(df, file.path(file_dir, paste0(form_year, '_non_mbcdi_',
                                                         age_group, '_',
                                                         lang_grp, '.csv')))
  } else {
    message('Error in importing data.')
  }
}
```

Now, let's scale using `mapply()`

```{r}
mapply(import_xlsx_clean_save_non_mbcdi, rep('2021', 9),
       rep(c('12', '18', '24'), 3),
       rep(c('English', 'Bilingual_English', 'Bilingual_Spanish'), each = 3))

mapply(import_xlsx_clean_save_non_mbcdi, rep('2020', 9),
       rep(c('12', '18', '24'), 3),
       rep(c('English', 'Bilingual_English', 'Bilingual_Spanish'), each = 3))
```

Now, let's try to import and join the 2021 data.

```{r, eval=FALSE}
non_mbcdi_2021 <- purrr::map_df(list.files('tmp', '2021_non_mbcdi_12', full.names = TRUE), readr::read_csv, show_col_types = FALSE, col_types = rep('c', 255))
```

There are still column specification errors! Drat! <span class="red">NOTE: As of 2022-03-09, I omitted the evaluation of the prior chunk.</span>

Let's go old-school and use the `read.csv()` function to import and trim the files before we try to concatenate them.

```{r}
open_trim_csv <- function(fn, col_index = 246) {
  df <- read.csv(fn, as.is = TRUE)
  
  if (dim(df)[2] > 246) {
    df[, 1:246]
  } else {
    df
  }
  
  if (dim(df)[1] == 0) {
    message('No data in ', fn)
    NULL
  } else {
    df
  }
}
```

```{r}
f_all <- list.files('tmp', '202[01]_non_mbcdi_[12]', full.names = TRUE)
mmm <- purrr::map_df(f_all, open_trim_csv)
readr::write_csv(mmm, 'tmp/PLAY_non_mbcdi_all.csv')
xfun::gsub_file('tmp/PLAY_non_mbcdi_all.csv', 'group_combinedquestionnaires.', '')
xfun::gsub_file('tmp/PLAY_non_mbcdi_all.csv', 'group_homevisitquestionnaires.', '')
```


```{r}
play <- readr::read_csv('tmp/PLAY_non_mbcdi_all.csv')
```

So, I think we need to concatenate the CSVs as text files, dropping the extra column for the 12-mo-olds first.

```{r}
xtabs(~ site_id + age_group, data = play)
```

That seems to work.

Let's consolidate again.

```{r}
make_non_mbcdi_csv <- function() {
  mapply(import_xlsx_clean_save_non_mbcdi,
         rep('2021', 9),
         rep(c('12', '18', '24'), 3),
         rep(
           c('English', 'Bilingual_English', 'Bilingual_Spanish'),
           each = 3
         ))
  
  mapply(import_xlsx_clean_save_non_mbcdi,
         rep('2020', 9),
         rep(c('12', '18', '24'), 3),
         rep(
           c('English', 'Bilingual_English', 'Bilingual_Spanish'),
           each = 3
         ))
  
  f_all <-
    list.files('tmp', '202[01]_non_mbcdi_[12]', 
               full.names = TRUE)
  
  mmm <- purrr::map_df(f_all, open_trim_csv)
  readr::write_csv(mmm, 'tmp/PLAY_non_mbcdi_all.csv')
  xfun::gsub_file('tmp/PLAY_non_mbcdi_all.csv',
                  'group_combinedquestionnaires.',
                  '')
  xfun::gsub_file('tmp/PLAY_non_mbcdi_all.csv',
                  'group_homevisitquestionnaires.',
                  '')
}
```

