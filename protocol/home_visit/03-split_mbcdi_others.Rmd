---
title: "Separate MB-CDI from Other Questions"
subtitle: "Version `r Sys.time()`"
author: Rick Gilmore
output: 
  html_document:
    code_folding: show
    self_contained: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
params:
  project_root_dir: ".."
  csv_input_dir: 'data/csv/release_1.0/raw'
  csv_save_dir: 'data/csv/release_1.0/mbcdi_non'
  age_grps: ['12', '18', '24']
  lang_grps: ['English', 'Bilingual_English', 'Bilingual_Spanish']
  remove_identifying_data: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

This document imports a 'raw' CSV for a given form year, age group, and language group, and creates two new files: one with the MB-CDI data and one with all of the other survey questions.

By default, the document presumes that we want to convert **all** of the CSV files that meet the `params$form_years`, `params$age_grps`, and `params$lang_grps` constraints found in `params$csv_input_dir` to pairs of properly named CSVs and save them in `params$csv_save_dir`.

In addition, if `params$remove_identifiers` is `TRUE`, we run a `remove_identifiers()` function that deletes those columns with names, addresses, dates, email addresses, and phone numbers before saving the file. In practice, this only matters for the *non-MB-CDI* file(s).

# Setup

We source the helper functions in `R/kobo_export.R`.

```{r source_helpers}
source(file.path(params$project_root_dir, "R/kobo_export.R"))
library(tidyverse)
```

# Open file(s) and process

Because we have parameterized the form year, age groups, and language groups, we can use the `mapply()` function here -- as long as we make sure that the parameter vectors have the right length and composition.

## Non-MB-CDI data

```{r import_save_non_mbcdi_csv, eval=FALSE}
# Deprecate this since we are not using form_year
mapply(import_raw_extract_split_save,
       form_year = rep(params$form_years, 9),
       age_grp = rep(params$age_grps, 3),
       lang_grp = rep(params$lang_grps, each = 3),
       csv_input_dir = params$csv_input_dir,
       csv_save_dir = params$csv_save_dir,
       these_questions = 'non_mbcdi',
       remove_identifying_data = params$remove_identifying_data)
```

```{r import-save-non-mbcdi-csv}
csv_fns <-
  list.files(file.path(params$project_root_dir, params$csv_input_dir),
             '^[0-9]{6}_raw_[12|18|24]',
             full.names = TRUE)

purrr::map(
  csv_fns,
  open_split_save,
  csv_save_dir = file.path(params$project_root_dir, params$csv_save_dir),
  these_questions = 'non_mbcdi'
)
```

## MB-CDI data

Extracting the MB-CDI data has nearly the same function call, but the `these_questions` parameter is set to 'mbcdi'.

```{r import_save_mbcdi_csv}
# mapply(import_raw_extract_split_save, 
#        form_year = rep(params$form_years, 9), 
#        age_grp = rep(params$age_grps, 3),
#        lang_grp = rep(params$lang_grps, each = 3),
#        csv_input_dir = params$csv_input_dir,
#        csv_save_dir = params$csv_save_dir,
#        these_questions = 'mbcdi',
#        remove_identifying_data = params$remove_identifying_data)

purrr::map(
  csv_fns,
  open_split_save,
  csv_save_dir = file.path(params$project_root_dir, params$csv_save_dir),
  these_questions = 'mbcdi'
)
```

