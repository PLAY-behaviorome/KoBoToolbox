---
title: "KoBoToolbox Data Download"
subtitle: "Version `r Sys.time()`"
author: Rick Gilmore
output: 
  html_document:
    code_folding: show
    self_contained: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
params:
  project_root_dir: ".."
  xlsx_download_dir: 'data/xlsx/release_1.0'
  download_xlsx: true
  update_old: false
  update_active: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

This document exports visit survey data from KoBoToolbox, does minimal cleaning, and saves the data as a CSV.

# Setup

The PLAY Project uses KoBoToolbox to collect data from parents and researchers using a tablet application. 

## Authentication

The data are stored in an account on <https://kf.kobotoolbox.org>. The login credentials for that account are shared among the PLAY Project staff. To access the site's API programmatically, an API key was downloaded and added to the local `~/.Renviron` file. To test whether the local system has the API key installed, run the following command `Sys.getenv("KOBO_API_KEY")`. With the API key installed, several custom functions in `R/kobo_export.R` can be run.

### Check KoBo API Key

```{r check-api-key}
kb_api <- Sys.getenv("KOBO_API_KEY")
if ((length(kb_api) != 1) || (!is.character(kb_api))) {
  stop("`KOBO_API_KEY` not installed in .Renviron")
} else {
  message("`KOBO_API_KEY` installed.")
}
```

## Load/source helper functions

```{r source-helpers}
source(file.path(params$project_root_dir, "R/kobo_export.R"))
```

## Install dependencies

The helper functions require several external packages. To confirm that these are installed, run the following chunk.

```{r install-dependencies}
install_kobo_packages()
```

# Download data

```{r list-kobo-forms}
kb_df <- list_kobo_data()
if ((dim(kb_df) < 1) || (!is.data.frame(kb_df))) {
  stop("Error in selecting surveys from KoBoToolbox.")
}

# Restrict to surveys collected at home
kb_home <- kb_df %>%
  dplyr::filter(., stringr::str_detect(title, "Home"))

if ((dim(kb_home)[1] < 1) || (!is.data.frame(kb_home))) {
  stop("Error in selecting home surveys from KoBoToolbox.")
}
```

Active forms have id's > 700000.

```{r select-active-forms}
kb_home <- kb_home %>%
  dplyr::filter(., id > 700000)
```


## Download old data

```{r download-old-data, eval=FALSE}
bulk_download_kobo_forms(
  kb_home,
  '2020',
  update_form = params$update_old,
  download_xlsx = params$download_xlsx,
  download_dir = params$xlsx_download_dir
)
```

## Download active data

As of 2022-03-09, the 2021 forms are the active ones. So, we have set `params$update_active` == `r params$update_active` by default.

```{r download-active-forms}
bulk_download_kobo_forms(
  kb_home,
  update_form = params$update_active,
  download_xlsx = params$download_xlsx,
  download_dir = file.path(params$project_root_dir, params$xlsx_download_dir)
)
```

## Normalize file names

Some of the form names are inconsistent, so we normalize them to fit the following pattern:

`<form_id>_PLAY_HomeQuestionnaires_<age_group>_<lang_group>.xlsx`

```{r}
fl <-
  list.files(file.path(params$project_root_dir, params$xlsx_download_dir),
             full.names = TRUE)
fl_home_old <- fl[stringr::str_detect(fl, 'Home')]
fl_home_new <- purrr::map_chr(fl_home_old, make_standard_form_name)
file.rename(fl_home_old, fl_home_new)
```
