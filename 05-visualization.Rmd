# Visualizations {-}

## Recruiting calls data {-}

Cumulative screening/recruiting calls by site.

```{r}
library(targets)
tar_load(calls_plot)
calls_plot
```

Number of screening calls by site.

```{r}
tar_load(bar_plot)
bar_plot
```

## Demographics

Child age in months (`child_age_mos`) by `child_sex`.

```{r}
targets::tar_load(demog_submissions)
demog_submissions %>%
  dplyr::filter(., !is.na(child_age_mos), !is.na(child_sex)) %>%
  ggplot() +
  aes(child_age_mos, fill = child_sex) +
  geom_histogram(bins = 50)
```

::: {.rmdnote}
Some of the code to clean the `demog_submissions` variables could be incorporated into an earlier stage of the workflow.
:::

Language(s) spoken to child by `child_sex`.

```{r}
demog_submissions <- demog_submissions %>%
  dplyr::mutate(., language_to_child = stringr::str_replace_all(language_to_child, " ", "_"))
xtabs(formula = ~ child_sex + language_to_child, data = demog_submissions)
```

Mother race and ethnicity.

```{r}
demog_submissions <- demog_submissions %>%
  dplyr::mutate(
    .,
    mother_race = dplyr::recode(
      mother_race,
      morethanone = "more_than_one",
      americanindian = "american_indian"
    ),
    mother_ethnicity = dplyr::recode(
      mother_ethnicity,
      hispanic_or_la = "hispanic",
      not_hispanic_o = "not_hispanic",
      nothispanic = "not_hispanic"
    )
  )
xtabs(formula = ~ mother_race + mother_ethnicity,
      data = demog_submissions)
```

## Recruiting locations

::: {.rmdimportant}
For privacy reasons, we do not expose or share address information.
The following commands retrieve address information from the raw data files and then retrieve geographic information using the U.S. Census API.
In the future, we may decide to link an individual respondent's information to their County.
:::

Create helper functions to make a tibble with a repondent's address.

```{r}
make_address <- function(i, df, survey_type = 'new') {
  require(dplyr)
  require(tibble)
  this_row <- df[i, ]
  if (survey_type == 'new') {
  out_df <- this_row %>%
    dplyr::select(
      .,
      addr1 = `play_demo_questionnaire/group_contact_info/group_address/parent_address_1`,
      addr2 = `play_demo_questionnaire/group_contact_info/group_address/parent_address_2`,
      city = `play_demo_questionnaire/group_contact_info/group_address/city`,
      state = `play_demo_questionnaire/group_contact_info/group_address/state`
    )  
  } else {
  out_df <- this_row %>%
    dplyr::select(
      .,
      addr1 = `play_phone_questionnaire/group_contact_info/group_address/parent_address_1`,
      addr2 = `play_phone_questionnaire/group_contact_info/group_address/parent_address_2`,
      city = `play_phone_questionnaire/group_contact_info/group_address/city`,
      state = `play_phone_questionnaire/group_contact_info/group_address/state`)
    
  }

  if ((!is.na(out_df$addr1) && (!is.na(out_df$city) && (!is.na(out_df$state))))) {
    addr <- with(out_df, paste0(addr1, ", ", city, ", ", state))
    tibble(singlelineaddr = addr)
  } else {
    NULL
  }
}

make_addresses <- function(df, survey_type) {
  require(purrr)
  purrr::map_df(1:dim(df)[1], make_address, df, survey_type)
}
```

Create aggregate data file with address information for the three screening data files.

```{r}
fns <- list.files("data/csv/screening",full.names = TRUE)

df1 <- readr::read_csv(fns[1], show_col_types = FALSE)
df2 <- readr::read_csv(fns[2], show_col_types = FALSE)
df3 <- readr::read_csv(fns[3], show_col_types = FALSE)

ad1 <- make_addresses(df1, 'old')
ad2 <- make_addresses(df2, 'new')
ad3 <- make_addresses(df3, 'new')

add <- rbind(ad1, ad2, ad3)
```

Helper function to gather Census geographic information in bulk.

```{r}
get_multiple_census_geos <- function(addrs) {
  require(tidygeocoder)
  addrs %>% tidygeocoder::geocode(
    address = singlelineaddr,
    method = "census",
    full_results = TRUE,
    api_options = list(census_return_type = 'geographies')
  )
}
```

Retrieve the Census geographic information.

```{r}
geos <- get_multiple_census_geos(add)
```

Helper function to plot lat and long of recruiting sites on a U.S. map.

```{r}
plot_screening_sites <- function(geo_df) {
  require(ggmap)
  require(dplyr)
  require(ggplot2)
  
  geo_df <- geo_df %>%
    dplyr::filter(., !is.na(lat), !is.na(long))
  
  usa <- ggmap::get_map("USA", zoom=4)
  usa %>%
    ggmap::ggmap() +
    ggplot2::geom_point(data = geo_df, aes(x = long, y = lat))
}
```

Plot the map.

```{r}
plot_screening_sites(geos)
```

