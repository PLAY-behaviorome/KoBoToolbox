---
title: "Export measures by form"
author: "Rick Gilmore"
date: "`r Sys.time()`"
output: 
  html_document:
    code_folding: hide
    self_contained: yes
params:
  kb_dir: '~/Box/PLAY-Project@/PLAY_Questionnaires (temporary)/KBTB Files'
  csv_dir: 'csv/by_form'
  db_login: 'email@provider.com'
  force_regeneration: True
  force_overwrite_agg_files: True
---

# Purpose

This report generates a set of CSV files for each KoBoToolbox form and measure.

To render the report, `rmarkdown::render('export-measures-by-form.Rmd', params=list(db_login='<YOUR_DB_LOGIN>'))`.

# Set-up

We source two packages for specific commands, source a set of specific functions needed for these operations, and log-in to Databrary.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)  # for pipe '%>%'
library(readxl)     # for cell_cols()

source("R/kobotoolbox.R")

databraryapi::login_db(params$db_login)
```

# By form {.tabset}

## 12_English

```{r 12-eng-this-form}
this_form <- '12_English'
if (is.null(return_matching_kobo_form(this_form))) {
  message('No form found for `', this_form, '`.')
  run_form = FALSE
} else {
  run_form = TRUE
}
```

### Day of visit demog

```{r 12-eng-basic-demog}
if (run_form) {
  basic_demog <-
    load_kbform_measure(
      this_form,
      'basic_demog',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(basic_demog)
}
```

### MBCDI English Short

```{r 12-eng-mbcdi-short}
if (run_form) {
  mbcdi_eng_short <-
    load_kbform_measure(
      this_form,
      'mbcdi_eng_short',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(mbcdi_eng_short)
}
```

### DLL English Long

```{r 12-eng-dll-eng-long}
if (run_form) {
  dll_eng_long <-
    load_kbform_measure(
      this_form,
      'dll_eng_long',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(dll_eng_long)
}
```

### Health

```{r 12-eng-health}
if (run_form) {
  health <-
    load_kbform_measure(
      this_form,
      'health',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(health)
}
```

### ECBQ

```{r 12-eng-ecbq}
if (run_form) {
  ecbq <-
    load_kbform_measure(
      this_form,
      'ecbq',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(ecbq)
}
```

### Household labor

```{r 12-eng-labor}
if (run_form) {
  household_labor <-
    load_kbform_measure(
      this_form,
      'household_labor',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(household_labor)
}
```

### Media

```{r 12-eng-media}
if (run_form) {
  media <-
    load_kbform_measure(
      this_form,
      'media',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(media)
}
```

### Pets

```{r 12-eng-pets}
if (run_form) {
  pets <-
    load_kbform_measure(
      this_form,
      'pets',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(pets)
}
```

### Typical day

```{r 12-eng-typical}
if (run_form) {
  typical_day <-
    load_kbform_measure(
      this_form,
      'typical_day',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(typical_day)
}
```

### Locomotor milestones

```{r 12-eng-loco}
if (run_form) {
  loco_milestones <-
    load_kbform_measure(
      this_form,
      'loco_milestones',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(loco_milestones)
}
```

### Compare with Databrary

```{r 12-eng-databrary}
if (run_form) {
  these_play_ids <- basic_demog$play_site_id
  qa_db <- tibble::tibble(these_play_ids)
  
  qa_db <- qa_db %>%
    dplyr::mutate(
      .,
      child_dob = basic_demog$child_dob,
      dob_equate = purrr::map(these_play_ids, kb_eq_db_dob_by_id, this_form),
      session_date_equate = purrr::map(these_play_ids, 
                                       kb_eq_db_session_date_by_id, this_form),
      child_sex = basic_demog$child_sex,
      sex_equate = purrr::map(these_play_ids, kb_eq_db_sex_by_id, this_form),
    )
  
  qa_db %>%
    kableExtra::kable(., format = 'html') %>%
    kableExtra::kable_styling(.)
}
```


## 18_English
```{r 18-eng-this-form}
this_form <- '18_English'
if (is.null(return_matching_kobo_form(this_form))) {
  message('No form found for `', this_form, '`.')
  run_form = FALSE
} else {
  run_form = TRUE
}
```

### Day of visit demog

```{r 18-eng-visit-demog}
if (run_form) {
  basic_demog <-
    load_kbform_measure(
      this_form,
      'basic_demog',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(basic_demog)
}
```

### MBCDI English Short

```{r 18-eng-mbcdi-eng-short}
if (run_form) {
  mbcdi_eng_short <-
    load_kbform_measure(
      this_form,
      'mbcdi_eng_short',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(mbcdi_eng_short)
}
```

### DLL English Long

```{r 18-eng-dll-eng-long}
if (run_form) {
  dll_eng_long <-
    load_kbform_measure(
      this_form,
      'dll_eng_long',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(dll_eng_long)
}
```

### Health

```{r 18-eng-health}
if (run_form) {
  health <-
    load_kbform_measure(
      this_form,
      'health',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(health)
}
```

### ECBQ

```{r 18-eng-ecbq}
if (run_form) {
  ecbq <-
    load_kbform_measure(
      this_form,
      'ecbq',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(ecbq)
}
```

### Household labor

```{r 18-eng-labor}
if (run_form) {
  household_labor <-
    load_kbform_measure(
      this_form,
      'household_labor',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(household_labor)
}
```

### Media

```{r 18-eng-media}
if (run_form) {
  media <-
    load_kbform_measure(
      this_form,
      'media',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(media)
}
```

### Pets

```{r 18-eng-pets}
if (run_form) {
  pets <-
    load_kbform_measure(
      this_form,
      'pets',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(pets)
}
```

### Typical day

```{r 18-eng-typical}
if (run_form) {
  typical_day <-
    load_kbform_measure(
      this_form,
      'typical_day',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(typical_day)
}
```

### Locomotor milestones

```{r 18-eng-loco}
if (run_form) {
  loco_milestones <-
    load_kbform_measure(
      this_form,
      'loco_milestones',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(loco_milestones)
}
```

### Compare with Databrary

```{r 18-eng-databrary}
if (run_form) {
  these_play_ids <- basic_demog$play_site_id
  qa_db <- tibble::tibble(these_play_ids)
  
  qa_db <- qa_db %>%
    dplyr::mutate(
      .,
      child_dob = basic_demog$child_dob,
      dob_equate = purrr::map(these_play_ids, kb_eq_db_dob_by_id, this_form),
      session_date_equate = purrr::map(these_play_ids, 
                                       kb_eq_db_session_date_by_id, this_form),
      child_sex = basic_demog$child_sex,
      sex_equate = purrr::map(these_play_ids, kb_eq_db_sex_by_id, this_form),
    )
  
  qa_db %>%
    kableExtra::kable(., format = 'html') %>%
    kableExtra::kable_styling(.)
}
```

## 24_English

```{r 24-eng-this-form}
this_form <- '24_English'
if (is.null(return_matching_kobo_form(this_form))) {
  message('No form found for `', this_form, '`.')
  run_form = FALSE
} else {
  run_form = TRUE
}
```

### Day of visit demog

```{r 24-eng-basic-demog}
if (run_form) {
  basic_demog <-
    load_kbform_measure(
      this_form,
      'basic_demog',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(basic_demog)
}
```

### MBCDI English Short

```{r 24-eng-mbcdi-eng-short}
if (run_form) {
  mbcdi_eng_short <-
    load_kbform_measure(
      this_form,
      'mbcdi_eng_short',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(mbcdi_eng_short)
}
```

### DLL English Long

```{r 24-eng-dll-eng-long}
if (run_form) {
  dll_eng_long <-
    load_kbform_measure(
      this_form,
      'dll_eng_long',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(dll_eng_long)
}
```

### Health

```{r 24-eng-health}
if (run_form) {
  health <-
    load_kbform_measure(
      this_form,
      'health',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(health)
}
```

### ECBQ

```{r 24-eng-ecbq}
if (run_form) {
  ecbq <-
    load_kbform_measure(
      this_form,
      'ecbq',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(ecbq)
}
```

### Household labor

```{r 24-eng-labor}
if (run_form) {
  household_labor <-
    load_kbform_measure(
      this_form,
      'household_labor',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(household_labor)
}
```

### Media

```{r 24-eng-media}
if (run_form) {
  media <-
    load_kbform_measure(
      this_form,
      'media',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(media)
}
```

### Pets

```{r 24-eng-pets}
if (run_form) {
  pets <-
    load_kbform_measure(
      this_form,
      'pets',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(pets)
}
```

### Typical day

```{r 24-eng-typical}
if (run_form) {
  typical_day <-
    load_kbform_measure(
      this_form,
      'typical_day',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(typical_day)
}
```

### Locomotor milestones

```{r 24-eng-loco}
if (run_form) {
  loco_milestones <-
    load_kbform_measure(
      this_form,
      'loco_milestones',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(loco_milestones)
}
```

### Compare with Databrary

```{r 24-eng-databrary}
if (run_form) {
  these_play_ids <- basic_demog$play_site_id
  qa_db <- tibble::tibble(these_play_ids)
  
  qa_db <- qa_db %>%
    dplyr::mutate(
      .,
      child_dob = basic_demog$child_dob,
      dob_equate = purrr::map(these_play_ids, kb_eq_db_dob_by_id, this_form),
      session_date_equate = purrr::map(these_play_ids, 
                                       kb_eq_db_session_date_by_id, this_form),
      child_sex = basic_demog$child_sex,
      sex_equate = purrr::map(these_play_ids, kb_eq_db_sex_by_id, this_form),
    )
  
  qa_db %>%
    kableExtra::kable(., format = 'html') %>%
    kableExtra::kable_styling(.)
}
```

## 12_Bilingual_English

```{r 12-biling-eng-this-form}
this_form <- '12_Bilingual_English'
if (is.null(return_matching_kobo_form(this_form))) {
  message('No form found for `', this_form, '`.')
  run_form = FALSE
} else {
  run_form = TRUE
}
```

### Day of visit demog

```{r 12-biling-eng-basic-demog}
if (run_form) {
  basic_demog <-
    load_kbform_measure(
      this_form,
      'basic_demog',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(basic_demog)
}
```

### MBCDI English Short

```{r 12-biling-eng-mbcdi-eng-short}
if (run_form) {
  mbcdi_eng_short <-
    load_kbform_measure(
      this_form,
      'mbcdi_eng_short',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(mbcdi_eng_short)
}
```

### MBCDI Spanish Short

```{r 12-biling-eng-mbcdi-span-short}
if (run_form) {
  mbcdi_span_short <-
    load_kbform_measure(
      this_form,
      'mbcdi_span_short',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(mbcdi_span_short)
}
```

### DLL English Short

```{r 12-biling-eng-dll-eng-short, eval=FALSE}
if (run_form) {
  dll_eng_short <-
    load_kbform_measure(
      this_form,
      'dll_eng_short',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(dll_eng_short)
}
```

### DLL Spanish Short

```{r 12-biling-eng-dll-span-short, eval=FALSE}
if (run_form) {
  dll_span_short <-
    load_kbform_measure(
      this_form,
      'dll_span_short',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(dll_span_short)
}
```

### DLL Bilingual Long

```{r 12-biling-eng-dll-biling-long, eval=FALSE}
if (run_form) {
  dll_biling_long <-
    load_kbform_measure(
      this_form,
      'dll_biling_long',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(dll_eng_long)
}
```

### Health

```{r 12-biling-eng-health}
if (run_form) {
  health <-
    load_kbform_measure(
      this_form,
      'health',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(health)
}
```

### ECBQ

```{r 12-biling-eng-ecbq}
if (run_form) {
  ecbq <-
    load_kbform_measure(
      this_form,
      'ecbq',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(ecbq)
}
```

### Household labor

```{r 12-biling-eng-labor}
if (run_form) {
  household_labor <-
    load_kbform_measure(
      this_form,
      'household_labor',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(household_labor)
}
```

### Media

```{r 12-biling-eng-media}
if (run_form) {
  media <-
    load_kbform_measure(
      this_form,
      'media',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(media)
}
```

### Pets

```{r 12-biling-eng-pets}
if (run_form) {
  pets <-
    load_kbform_measure(
      this_form,
      'pets',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(pets)
}
```

### Typical day

```{r 12-biling-eng-typical}
if (run_form) {
  typical_day <-
    load_kbform_measure(
      this_form,
      'typical_day',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(typical_day)
}
```

### Locomotor milestones

```{r 12-biling-eng-loco}
if (run_form) {
  loco_milestones <-
    load_kbform_measure(
      this_form,
      'loco_milestones',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(loco_milestones)
}
```

### Compare with Databrary

```{r 12-biling-eng-databrary}
if (run_form) {
  these_play_ids <- basic_demog$play_site_id
  qa_db <- tibble::tibble(these_play_ids)
  
  qa_db <- qa_db %>%
    dplyr::mutate(
      .,
      child_dob = basic_demog$child_dob,
      dob_equate = purrr::map(these_play_ids, kb_eq_db_dob_by_id, this_form),
      session_date_equate = purrr::map(these_play_ids, kb_eq_db_session_date_by_id, this_form),
      child_sex = basic_demog$child_sex,
      sex_equate = purrr::map(these_play_ids, kb_eq_db_sex_by_id, this_form),
    )
  
  qa_db %>%
    kableExtra::kable(., format = 'html') %>%
    kableExtra::kable_styling(.)
}
```

## 18_Bilingual_English

```{r}
this_form <- '18_Bilingual_English'
if (is.null(return_matching_kobo_form(this_form))) {
  message('No form found for `', this_form, '`.')
  run_form = FALSE
} else {
  run_form = TRUE
}
```

### Day of visit demog

```{r, eval=FALSE}
if (run_form) {
  basic_demog <- load_kbform_measure(this_form, 'basic_demog', regenerate_if_missing = TRUE,
                                     save_regenerated = TRUE,
                                     force_regeneration = params$force_regeneration)
  str(basic_demog)  
}
```

### MBCDI English Short

```{r, eval=FALSE}
if (run_form) {
  mbcdi_eng_short <- load_kbform_measure(this_form, 'mbcdi_eng_short', regenerate_if_missing = TRUE,
                                         save_regenerated = TRUE,
                                         force_regeneration = params$force_regeneration)
  str(mbcdi_eng_short)  
}
```

### DLL English Long

This measure is not collected from `r this_form` participants.

```{r, eval=FALSE}
if (run_form) {
  dll_eng_long <- load_kbform_measure(this_form, 'dll_eng_long', regenerate_if_missing = TRUE,
                                      save_regenerated = TRUE,
                                      force_regeneration = params$force_regeneration)
  str(dll_eng_long)  
}
```

### DLL Spanish Short

```{r, eval=FALSE}
if (run_form) {
  dll_span_short <- load_kbform_measure(this_form, 'dll_span_short', regenerate_if_missing = TRUE,
                                        save_regenerated = TRUE,
                                        force_regeneration = params$force_regeneration)
  str(dll_span_short)  
}
```

### Health

```{r, eval=FALSE}
if (run_form) {
  health <- load_kbform_measure(this_form, 'health', regenerate_if_missing = TRUE,
                                save_regenerated = TRUE,
                                force_regeneration = params$force_regeneration)
  str(health)  
}
```

### ECBQ

```{r, eval=FALSE}
if (run_form) {
  ecbq <- load_kbform_measure(this_form, 'ecbq', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
  str(ecbq)  
}
```

### Household labor

```{r, eval=FALSE}
if (run_form) {
  household_labor <- load_kbform_measure(this_form, 'household_labor', regenerate_if_missing = TRUE,
                                         save_regenerated = TRUE,
                                         force_regeneration = params$force_regeneration)
  str(household_labor)  
}
```

### Media

```{r, eval=FALSE}
if (run_form) {
  media <- load_kbform_measure(this_form, 'media', regenerate_if_missing = TRUE,
                               save_regenerated = TRUE,
                               force_regeneration = params$force_regeneration)
  str(media)  
}
```

### Pets

```{r, eval=FALSE}
if (run_form) {
  pets <- load_kbform_measure(this_form, 'pets', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
  str(pets)  
}
```

### Typical day

```{r, eval=FALSE}
if (run_form) {
  typical_day <- load_kbform_measure(this_form, 'typical_day', regenerate_if_missing = TRUE,
                                     save_regenerated = TRUE,
                                     force_regeneration = params$force_regeneration)
  str(typical_day)  
}
```

### Locomotor milestones

```{r 18-biling-eng-loco, eval=FALSE}
if (run_form) {
  loco_milestones <-
    load_kbform_measure(
      this_form,
      'loco_milestones',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(loco_milestones)
}
```

### Compare with Databrary

```{r, eval=FALSE}
if (run_form) {
  these_play_ids <- basic_demog$play_site_id
  qa_db <- tibble::tibble(these_play_ids)
  
  qa_db <- qa_db %>%
    dplyr::mutate(., child_dob = basic_demog$child_dob,
                  dob_equate = purrr::map(these_play_ids, kb_eq_db_dob_by_id, this_form),
                  session_date_equate = purrr::map(these_play_ids, kb_eq_db_session_date_by_id, this_form),
                  child_sex = basic_demog$child_sex,
                  sex_equate = purrr::map(these_play_ids, kb_eq_db_sex_by_id, this_form),
    )
  
  qa_db %>%
    kableExtra::kable(., format = 'html') %>%
    kableExtra::kable_styling(.)  
}
```

## 24_Bilingual_English

```{r 24-biling-eng}
this_form <- '24_Bilingual_English'
if (is.null(return_matching_kobo_form(this_form))) {
  message('No form found for `', this_form, '`.')
  run_form = FALSE
} else {
  run_form = TRUE
}
```

### Day of visit demog

```{r 24-biling-eng-basic-demog}
if (run_form) {
  basic_demog <- load_kbform_measure(this_form, 'basic_demog', regenerate_if_missing = TRUE,
                                     save_regenerated = TRUE,
                                     force_regeneration = params$force_regeneration)
  str(basic_demog)  
}
```

### MBCDI English Short

```{r 24-biling-eng-mbcdi-eng-short}
if (run_form) {
mbcdi_eng_short <- load_kbform_measure(this_form, 'mbcdi_eng_short', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
str(mbcdi_eng_short)  
}
```

### DLL English Long

This measure is not collected from `r this_form` participants.

```{r 24-biling-eng-dll-eng-long, eval=FALSE}
if (run_form) {
  dll_eng_long <- load_kbform_measure(this_form, 'dll_eng_long', regenerate_if_missing = TRUE,
                                      save_regenerated = TRUE,
                                      force_regeneration = params$force_regeneration)
  str(dll_eng_long)  
}
```

### DLL Spanish Short

```{r 24-biling-eng-dll-span-short}
if (run_form) {
  dll_span_short <- load_kbform_measure(this_form, 'dll_span_short', regenerate_if_missing = TRUE,
                                        save_regenerated = TRUE,
                                        force_regeneration = params$force_regeneration)
  str(dll_span_short)  
}
```

### Health

```{r 24-biling-eng-health}
if (run_form) {
  health <- load_kbform_measure(this_form, 'health', regenerate_if_missing = TRUE,
                                save_regenerated = TRUE,
                                force_regeneration = params$force_regeneration)
  str(health)  
}
```

### ECBQ

```{r 24-biling-eng-ecbq}
if (run_form) {
  ecbq <- load_kbform_measure(this_form, 'ecbq', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
  str(ecbq)  
}
```

### Household labor

```{r 24-biling-eng-household-labor}
if (run_form) {
  household_labor <- load_kbform_measure(this_form, 'household_labor', regenerate_if_missing = TRUE,
                                         save_regenerated = TRUE,
                                         force_regeneration = params$force_regeneration)
  str(household_labor)  
}
```

### Media

```{r 24-biling-eng-media}
if (run_form) {
  media <- load_kbform_measure(this_form, 'media', regenerate_if_missing = TRUE,
                               save_regenerated = TRUE,
                               force_regeneration = params$force_regeneration)
  str(media)  
}
```

### Pets

```{r 24-biling-eng-pets}
if (run_form) {
  pets <- load_kbform_measure(this_form, 'pets', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
  str(pets)  
}
```

### Typical day

```{r 24-biling-eng-typical-day}
if (run_form) {
  typical_day <- load_kbform_measure(this_form, 'typical_day', regenerate_if_missing = TRUE,
                                     save_regenerated = TRUE,
                                     force_regeneration = params$force_regeneration)
  str(typical_day)  
}
```

### Locomotor milestones

```{r 24-biling-eng-loco}
if (run_form) {
  loco_milestones <-
    load_kbform_measure(
      this_form,
      'loco_milestones',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(loco_milestones)
}
```

### Compare with Databrary

```{r, eval=FALSE}
if (run_form) {
  these_play_ids <- basic_demog$play_site_id
  qa_db <- tibble::tibble(these_play_ids)
  
  qa_db <- qa_db %>%
    dplyr::mutate(
      .,
      child_dob = basic_demog$child_dob,
      dob_equate = purrr::map(these_play_ids, kb_eq_db_dob_by_id, this_form),
      session_date_equate = purrr::map(these_play_ids, kb_eq_db_session_date_by_id, this_form),
      child_sex = basic_demog$child_sex,
      sex_equate = purrr::map(these_play_ids, kb_eq_db_sex_by_id, this_form),
    )
  
  qa_db %>%
    kableExtra::kable(., format = 'html') %>%
    kableExtra::kable_styling(.)
}
```

## 12_Bilingual_Spanish

```{r 12-biling-span-run-form}
this_form <- '12_Bilingual_Spanish'
if (is.null(return_matching_kobo_form(this_form))) {
  message('No form found for `', this_form, '`.')
  run_form = FALSE
} else {
  run_form = TRUE
}
```

### Day of visit demog

```{r 12-biling-span-demog}
if (run_form) {
  basic_demog <-
    load_kbform_measure(
      this_form,
      'basic_demog',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(basic_demog)
}
```

### MBCDI English Short

```{r 12-biling-span-mbcdi-eng-short}
if (run_form) {
  mbcdi_eng_short <-
    load_kbform_measure(
      this_form,
      'mbcdi_eng_short',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(mbcdi_eng_short)
}
```

### MBCDI Spanish Short

```{r 12-biling-span-mbcdi-span-short}
if (run_form) {
  mbcdi_span_short <-
    load_kbform_measure(
      this_form,
      'mbcdi_span_short',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(mbcdi_eng_short)
}
```

### DLL Spanish Short

```{r 12-biling-span-dll-span-short}
if (run_form) {
  dll_span_short <-
    load_kbform_measure(
      this_form,
      'dll_span_short',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(dll_span_short)
}
```

### DLL English Short

```{r 12-biling-span-dll-eng-short, eval=FALSE}
if (run_form) {
  dll_span_short <-
    load_kbform_measure(
      this_form,
      'dll_eng_short',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(dll_span_short)
}
```

### DLL Bilingual Long

```{r 12-biling-span-dll-biling-long, eval=FALSE}
if (run_form) {
  dll_biling_long <-
    load_kbform_measure(
      this_form,
      'dll_biling_long',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(dll_span_short)
}
```

### Health

```{r}
health <- load_kbform_measure(this_form, 'health', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
str(health)
```

### ECBQ

```{r}
ecbq <- load_kbform_measure(this_form, 'ecbq', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
str(ecbq)
```

### Household labor

```{r}
household_labor <- load_kbform_measure(this_form, 'household_labor', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
str(household_labor)
```

### Media

```{r}
media <- load_kbform_measure(this_form, 'media', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
str(media)
```

### Pets

```{r}
pets <- load_kbform_measure(this_form, 'pets', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
str(pets)
```

### Typical day

```{r}
typical_day <- load_kbform_measure(this_form, 'typical_day', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
str(typical_day)
```

### Locomotor milestones

```{r 12-biling-span-loco}
if (run_form) {
  loco_milestones <-
    load_kbform_measure(
      this_form,
      'loco_milestones',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(loco_milestones)
}
```

### Compare with Databrary

```{r}
these_play_ids <- basic_demog$play_site_id
qa_db <- tibble::tibble(these_play_ids)

qa_db <- qa_db %>%
  dplyr::mutate(., child_dob = basic_demog$child_dob,
                dob_equate = purrr::map(these_play_ids, kb_eq_db_dob_by_id, this_form),
                session_date_equate = purrr::map(these_play_ids, kb_eq_db_session_date_by_id, this_form),
                child_sex = basic_demog$child_sex,
                sex_equate = purrr::map(these_play_ids, kb_eq_db_sex_by_id, this_form),
                )

qa_db %>%
  kableExtra::kable(., format = 'html') %>%
  kableExtra::kable_styling(.)
```

## 18_Bilingual_Spanish

```{r}
this_form <- '18_Bilingual_Spanish'
if (is.null(return_matching_kobo_form(this_form))) {
  message('No form found for `', this_form, '`.')
  run_form = FALSE
} else {
  run_form = TRUE
}
```

### Day of visit demog

```{r, eval=FALSE}
if (run_form) {
  basic_demog <- load_kbform_measure(this_form, 'basic_demog', regenerate_if_missing = TRUE,
                                     save_regenerated = TRUE,
                                     force_regeneration = params$force_regeneration)
  str(basic_demog)  
}
```

### MBCDI English Short

```{r, eval=FALSE}
if (run_form) {
  mbcdi_eng_short <- load_kbform_measure(this_form, 'mbcdi_eng_short', regenerate_if_missing = TRUE,
                                         save_regenerated = TRUE,
                                         force_regeneration = params$force_regeneration)
  str(mbcdi_eng_short)  
}
```

### DLL English Long

This measure is not collected from `r this_form` participants.

```{r, eval=FALSE}
if (run_form) {
  dll_eng_long <- load_kbform_measure(this_form, 'dll_eng_long', regenerate_if_missing = TRUE,
                                      save_regenerated = TRUE,
                                      force_regeneration = params$force_regeneration)
  str(dll_eng_long)  
}
```

### DLL Spanish Short

```{r, eval=FALSE}
if (run_form) {
  dll_span_short <- load_kbform_measure(this_form, 'dll_span_short', regenerate_if_missing = TRUE,
                                        save_regenerated = TRUE,
                                        force_regeneration = params$force_regeneration)
  str(dll_span_short)  
}
```

### Health

```{r, eval=FALSE}
if (run_form) {
  health <- load_kbform_measure(this_form, 'health', regenerate_if_missing = TRUE,
                                save_regenerated = TRUE,
                                force_regeneration = params$force_regeneration)
  str(health)  
}
```

### ECBQ

```{r, eval=FALSE}
if (run_form) {
  ecbq <- load_kbform_measure(this_form, 'ecbq', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
  str(ecbq)  
}
```

### Household labor

```{r, eval=FALSE}
if (run_form) {
  household_labor <- load_kbform_measure(this_form, 'household_labor', regenerate_if_missing = TRUE,
                                         save_regenerated = TRUE,
                                         force_regeneration = params$force_regeneration)
  str(household_labor)  
}
```

### Media

```{r, eval=FALSE}
if (run_form) {
  media <- load_kbform_measure(this_form, 'media', regenerate_if_missing = TRUE,
                               save_regenerated = TRUE,
                               force_regeneration = params$force_regeneration)
  str(media)  
}
```

### Pets

```{r, eval=FALSE}
if (run_form) {
  pets <- load_kbform_measure(this_form, 'pets', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
  str(pets)  
}
```

### Typical day

```{r, eval=FALSE}
if (run_form) {
  typical_day <- load_kbform_measure(this_form, 'typical_day', regenerate_if_missing = TRUE,
                                     save_regenerated = TRUE,
                                     force_regeneration = params$force_regeneration)
  str(typical_day)  
}
```

### Locomotor milestones

```{r 18-biling-span-loco}
if (run_form) {
  loco_milestones <-
    load_kbform_measure(
      this_form,
      'loco_milestones',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(loco_milestones)
}
```

### Compare with Databrary

```{r, eval=FALSE}
if (run_form) {
  these_play_ids <- basic_demog$play_site_id
  qa_db <- tibble::tibble(these_play_ids)
  
  qa_db <- qa_db %>%
    dplyr::mutate(., child_dob = basic_demog$child_dob,
                  dob_equate = purrr::map(these_play_ids, kb_eq_db_dob_by_id, this_form),
                  session_date_equate = purrr::map(these_play_ids, kb_eq_db_session_date_by_id, this_form),
                  child_sex = basic_demog$child_sex,
                  sex_equate = purrr::map(these_play_ids, kb_eq_db_sex_by_id, this_form),
    )
  
  qa_db %>%
    kableExtra::kable(., format = 'html') %>%
    kableExtra::kable_styling(.)  
}
```

## 24_Bilingual_Spanish

```{r}
this_form <- '24_Bilingual_Spanish'
if (is.null(return_matching_kobo_form(this_form))) {
  message('No form found for `', this_form, '`.')
  run_form = FALSE
} else {
  run_form = TRUE
}
```

### Day of visit demog

```{r}
if (run_form) {
  basic_demog <- load_kbform_measure(this_form, 'basic_demog', regenerate_if_missing = TRUE,
                                     save_regenerated = TRUE,
                                     force_regeneration = params$force_regeneration)
  str(basic_demog)  
}
```

### MBCDI English Short

```{r}
if (run_form) {
mbcdi_eng_short <- load_kbform_measure(this_form, 'mbcdi_eng_short', 
                                       regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
str(mbcdi_eng_short)  
}
```

### DLL English Long

This measure is not collected from `r this_form` participants.

```{r, eval=FALSE}
if (run_form) {
  dll_eng_long <- load_kbform_measure(this_form, 'dll_eng_long', regenerate_if_missing = TRUE,
                                      save_regenerated = TRUE,
                                      force_regeneration = params$force_regeneration)
  str(dll_eng_long)  
}
```

### DLL Spanish Short

```{r}
if (run_form) {
  dll_span_short <- load_kbform_measure(this_form, 'dll_span_short', regenerate_if_missing = TRUE,
                                        save_regenerated = TRUE,
                                        force_regeneration = params$force_regeneration)
  str(dll_span_short)  
}
```

### DLL Bilingual Long

```{r}
if (run_form) {
  dll_biling_long <- load_kbform_measure(this_form, 'dll_biling_long',
                                         regenerate_if_missing = TRUE,
                                         save_regenerated = TRUE,
                                         force_regeneration =
                                           params$force_regeneration)
  str(dll_biling_long)  
}
```

### Health

```{r}
if (run_form) {
  health <- load_kbform_measure(this_form, 'health', regenerate_if_missing = TRUE,
                                save_regenerated = TRUE,
                                force_regeneration = params$force_regeneration)
  str(health)  
}
```

### ECBQ

```{r}
if (run_form) {
  ecbq <- load_kbform_measure(this_form, 'ecbq', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
  str(ecbq)  
}
```

### Household labor

```{r}
if (run_form) {
  household_labor <- load_kbform_measure(this_form, 'household_labor', regenerate_if_missing = TRUE,
                                         save_regenerated = TRUE,
                                         force_regeneration = params$force_regeneration)
  str(household_labor)  
}
```

### Media

```{r}
if (run_form) {
  media <- load_kbform_measure(this_form, 'media', regenerate_if_missing = TRUE,
                               save_regenerated = TRUE,
                               force_regeneration = params$force_regeneration)
  str(media)  
}
```

### Pets

```{r}
if (run_form) {
  pets <- load_kbform_measure(this_form, 'pets', regenerate_if_missing = TRUE,
                              save_regenerated = TRUE,
                              force_regeneration = params$force_regeneration)
  str(pets)  
}
```

### Typical day

```{r}
if (run_form) {
  typical_day <- load_kbform_measure(this_form, 'typical_day', regenerate_if_missing = TRUE,
                                     save_regenerated = TRUE,
                                     force_regeneration = params$force_regeneration)
  str(typical_day)  
}
```

### Locomotor milestones

```{r 24-biling-span-loco}
if (run_form) {
  loco_milestones <-
    load_kbform_measure(
      this_form,
      'loco_milestones',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(loco_milestones)
}
```

### Compare with Databrary

```{r}
if (run_form) {
  these_play_ids <- basic_demog$play_site_id
  qa_db <- tibble::tibble(these_play_ids)
  
  qa_db <- qa_db %>%
    dplyr::mutate(
      .,
      child_dob = basic_demog$child_dob,
      dob_equate = purrr::map(these_play_ids, kb_eq_db_dob_by_id, this_form),
      session_date_equate = purrr::map(these_play_ids, 
                                       kb_eq_db_session_date_by_id, this_form),
      child_sex = basic_demog$child_sex,
      sex_equate = purrr::map(these_play_ids, kb_eq_db_sex_by_id, this_form),
    )
  
  qa_db %>%
    kableExtra::kable(., format = 'html') %>%
    kableExtra::kable_styling(.)
}
```

## Demographic Questionnaire

```{r}
this_form <- 'Demographic_Questionnaire'
if (is.null(return_matching_kobo_form(this_form))) {
  message('No form found for `', this_form, '`.')
  run_form = FALSE
} else {
  run_form = TRUE
}
```

```{r}
if (run_form) {
  demog_quest <-
    load_kbform_measure(
      this_form,
      'demog_quest',
      regenerate_if_missing = TRUE,
      save_regenerated = TRUE,
      force_regeneration = params$force_regeneration
    )
  str(demog_quest)
}
```

# Create by-measure CSVs

**Note**: Some of the language measures should *not* be combined across 12 and 18/24 months.
We need to handle this more gracefully.
Until we do, I've commented-out the vocabulary measures.

```{r create-by-measure-csvs}
these_measures <- c(
  'basic_demog',
  'health',
  # 'mbcdi_eng_short',
  # 'mbcdi_span_short',
  # 'dll_eng_long',
  # 'dll_eng_short',
  # 'dll_span_short',
  # 'dll_biling_long',
  'ecbq',
  'pets',
  'media',
  'household_labor',
  'typical_day',
  'loco_milestones',
  'demog_quest'
)

purrr::map(these_measures, export_aggregate_csv_for_measure, force_overwrite = params$force_overwrite_agg_files)
```

# Create by-session, by-measure CSVs

For all by-measure CSVs in the `by_form` directory `r params$csv_dir`, export a CSV for each session and store in `csv/by_session`. 

```{r}
purrr::map(list.files(params$csv_dir, full.names = TRUE), export_sessions_measures_forms)
```

# Clean-up

```{r}
databraryapi::logout_db()
```

