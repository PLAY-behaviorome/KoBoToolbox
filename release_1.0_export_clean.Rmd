---
title: "release_1.0_export_clean"
subtitle: "Version `r Sys.time()`"
author: Rick Gilmore
output: 
  html_document:
    code_folding: hide
    self_contained: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
params:
  xlsx_download_dir: 'xlsx/release_1.0'
  csv_export_dir: 'csv/release_1.0'
  data_dict_fn: 'data_dict/xlsx/data_dict/xlsx/a8HyzdxnVjK53dt4fX3Vup.xlsx'
  download_xlsx: true
  update_2020: false
  databrary_login: default@youremail.com
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

This document exports visit survey data from KoBoToolbox, does minimal cleaning, and saves the data as a CSV.

To download and clean *all* of the data, execute `rmarkdown::render("release_1.0_export_clean.Rmd", params = list(update_2020 = TRUE))` from the console. Otherwise, run with the default parameter values: `rmarkdown::render("release_1.0_export_clean.Rmd")` which download the 2021+ Excel data files each time the document is run.

# Setup

The PLAY Project uses KoBoToolbox to collect data from parents and researchers using a tablet application. 

## Authentication

The data are stored in an account on <https://kf.kobotoolbox.org>. The login credentials for that account are shared among the PLAY Project staff. To access the site's API programmatically, an API key was downloaded and added to the local `~/.Renviron` file. To test whether the local system has the API key installed, run the following command `Sys.getenv("KOBO_API_KEY")`. With the API key installed, several custom functions in `R/kobo_export.R` can be run, as in the following chunk.

In addition, this document gathers information from Databrary.org using the `databraryapi` package. If you are an authorized Databrary user, you should run the document with the following parameters: `rmarkdown::render('release_1.0_export_clean.Rmd', params=list(databrary_login="<default@youremail.com>")`, substituting your actual Databrary account ID (email) for `<default@yourmail.com>`. 

```{r authenticate-databrary}
if (params$databrary_login == "default@youremail.com") {
  if (!file.exists('.databrary.RData')) stop("Must include Databrary credentials as document parameter.")
} else {
  databraryapi::login_db(params$databrary_login)
}
```

## Load/source helper functions

```{r source-helpers}
source("R/kobo_export.R")
source("R/kobo_databrary_integration.R")
```

## Install dependencies

The helper functions require several external packages. To confirm that these are installed, run the following chunk.

```{r install-dependencies}
install_kobo_packages()
```

# Download data

```{r list-kobo-forms}
kb_df <- list_kobo_data()

# Restrict to surveys collected at home
kb_home <- kb_df %>%
  dplyr::filter(., stringr::str_detect(title, "Home"))
```

## Download versions prior to 2021

```{r download-2020}
if (params$update_2020) {
  kb_home_2020 <- kb_home %>%
    dplyr::filter(., stringr::str_detect(title, "2020"))
  
  if (params$download_xlsx) {
    purrr::map(
      1:dim(kb_home_2020)[1],
      retrieve_save_xls_export,
      kb_df = kb_home_2020,
      save_dir = params$xlsx_download_dir # TODO: Create dir if it doesn't exist
    )
  } else {
    message('params$download_xlsx is FALSE; no data downloaded.')
  }
} else {
  message('2020 forms not updated.')
}
```

## Download 2021 data

As of 2022-03-09, the 2021 forms are the active ones.

```{r download-2021-plus}
kb_home_2021 <- kb_home %>%
  dplyr::filter(., stringr::str_detect(title, "2021"))

if (params$download_xlsx) {
  purrr::map(
    1:dim(kb_home_2021)[1],
    retrieve_save_xls_export,
    kb_df = kb_home_2021,
    save_dir = params$xlsx_download_dir
  )
} else {
  message('params$download_xlsx is FALSE; no data downloaded.')
}
```

# Generate data dictionary

We'll use the questions from the 12-mon-old English form as a basis.

```{r}
qs_12_eng <- readxl::read_excel("data_dict/xlsx/a8HyzdxnVjK53dt4fX3Vup.xlsx")
```

It might be easiest to merge the field names we get from the completed survey data with this data set and do the cleaning/excerpting on the combined file.

The following chunk is borrowed from `gather_clean_visit.Rmd`.

```{r}
data_12_eng <- readxl::read_excel("xlsx/release_1.0/740625_PLAY_HomeQuestionaires_12_English-2021-07-29.xlsx")
data_cols <- names(data_12_eng)
```

I'm going to add a `data_col_index` variable so that I can track when the data file column names line up with those in the questionnaire form and when they do not.

```{r}
data_qs_df <- tibble::tibble(data_col_index = 1:length(data_cols), data_col_name = basename(data_cols))
```

Now, let's try to join these. But let's sort on the indexing variable first.

```{r}
data_qs_df <- data_qs_df %>%
  dplyr::arrange(., data_col_name)
qs_12_eng <- qs_12_eng %>%
  dplyr::arrange(., name)

qs_data_df <- dplyr::left_join(qs_12_eng, data_qs_df, by = c("name" = "data_col_name"))
```

Drop rows with no matching column name.

```{r}
qs_data_selected <- qs_data_df %>%
  dplyr::filter(., !is.na(data_col_index)) %>%
  dplyr::arrange(., data_col_index) %>%
  dplyr::mutate(., data_column_longname = data_cols[data_col_index])
```

Let's trim some columns that seem unnecessary.

```{r}
qs_data_trimmed <- qs_data_selected %>%
  dplyr::select(
    .,
    -c(
      hint,
      read_only,
      calculation,
      appearance,
      default,
      constraint,
      constraint_message,
      relevant,
      `$given_name`
    )
  )
```

Remove MB-CDI questions.

```{r}
qs_data_non_mbcdi <- qs_data_trimmed %>%
  dplyr::filter(., !stringr::str_detect(data_column_longname, 'mcdi'))
```

Rename some columns and export.

```{r}
data_dict_df <- qs_data_non_mbcdi %>%
  dplyr::rename(., short_name = name,
                 long_name = data_column_longname,
                 question = label) %>%
  dplyr::select(., -c(required, data_col_index, type))

readr::write_csv(data_dict_df, 'data_dict/release_1.0_non_mbcdi_data_dictionary.csv')
```

# Create separate MB-CDI/non-MB-CDI CSVs

## Separate out MB-CDI data

We split the MB-CDI data from the other surveys. To do this, we define and use the following helper functions.

```{r}
extract_mcdi_col_names <- function(df) {
  stopifnot(is.data.frame(df))
  
  mcdi_qs <- stringr::str_detect(names(df), 'mcdi')
  mcdi_cols <- (1:length(names(df)))[mcdi_qs]
    
  names(df)[mcdi_cols]
}

extract_save_mcdi <- function(df, fn, save_file = FALSE) {
  stopifnot(is.data.frame(df))
  stopifnot(is.character(fn))
  stopifnot(is.logical(save_file))
  
  play_id_col <- (1:length(names(df)))[stringr::str_detect(names(df), 'participant_id')]
  
  mcdi_cols <- extract_mcdi_col_names(df)
    
  mcdi <- df %>%
    dplyr::select(., all_of(play_id_col), all_of(mcdi_cols))    
  
  if (save_file) readr::write_csv(mcdi, fn)
  
  mcdi
}

list_exported_xlsx_by_form <- function(download_dir = 'xlxs/release', age_mos = '12', lang_grp = 'English', form_year = '2021') {
  search_str <- paste0(age_mos, '_', lang_grp, '*.', form_year)
  list.files(download_dir, search_str, full.names = TRUE)
}

make_export_csv_fn <- function(export_dir = 'csv/release_1.0/raw', survey = 'mbcdi', age_mos = '12', lang_grp = 'English', form_year = '2021') {
  paste0(export_dir, '/', survey, '_', age_mos, '_', tolower(lang_grp), '_', form_year, '.csv')
}
```

**TODO: The helper functions in this document are designed with parameters to permit future use of `mapply()`.**

## Create separate data frames by form

```{r load_2021_xlxs}
home_12_eng_21 <-
  readxl::read_excel(list_exported_xlsx_by_form(params$xlsx_download_dir, '12', 'English', '2021'))
home_12_biling_eng_21 <-
  readxl::read_excel(
    list_exported_xlsx_by_form(params$xlsx_download_dir, '12', 'Bilingual_English', '2021')
  )
home_12_biling_span_21 <-
  readxl::read_excel(
    list_exported_xlsx_by_form(params$xlsx_download_dir, '12', 'Bilingual_Spanish', '2021')
  )

home_18_eng_21 <-
  readxl::read_excel(list_exported_xlsx_by_form(params$xlsx_download_dir, '18', 'English', '2021'))
home_18_biling_eng_21 <-
  readxl::read_excel(
    list_exported_xlsx_by_form(params$xlsx_download_dir, '18', 'Bilingual_English', '2021')
  )
home_18_biling_span_21 <-
  readxl::read_excel(
    list_exported_xlsx_by_form(params$xlsx_download_dir, '18', 'Bilingual_Spanish', '2021')
  )

home_24_eng_21 <-
  readxl::read_excel(list_exported_xlsx_by_form(params$xlsx_download_dir, '24', 'English', '2021'))
home_24_biling_eng_21 <-
  readxl::read_excel(
    list_exported_xlsx_by_form(params$xlsx_download_dir, '24', 'Bilingual_English', '2021')
  )
home_24_biling_span_21 <-
  readxl::read_excel(
    list_exported_xlsx_by_form(params$xlsx_download_dir, '24', 'Bilingual_Spanish', '2021')
  )
```

Unless `params$update_2020` is `TRUE`, we do not do the same for the 2020 data.

```{r load_export_2020_xlxs}
if (params$update_2020) {
  # Create separate data frames by age, language group
  home_12_eng_20 <-
    readxl::read_excel(list_exported_xlsx_by_form(params$xlsx_download_dir, '12', 'English', '2020'))
  home_12_biling_eng_20 <-
    readxl::read_excel(
      list_exported_xlsx_by_form(params$xlsx_download_dir, '12', 'Bilingual_English', '2020')
    )
  home_12_biling_span_20 <-
    readxl::read_excel(
      list_exported_xlsx_by_form(params$xlsx_download_dir, '12', 'Bilingual_Spanish', '2020')
    )
  
  home_18_eng_20 <-
    readxl::read_excel(list_exported_xlsx_by_form(params$xlsx_download_dir, '18', 'English', '2020'))
  home_18_biling_eng_20 <-
    readxl::read_excel(
      list_exported_xlsx_by_form(params$xlsx_download_dir, '18', 'Bilingual_English', '2020')
    )
  home_18_biling_span_20 <-
    readxl::read_excel(
      list_exported_xlsx_by_form(params$xlsx_download_dir, '18', 'Bilingual_Spanish', '2020')
    )
  
  home_24_eng_20 <-
    readxl::read_excel(list_exported_xlsx_by_form(params$xlsx_download_dir, '24', 'English', '2020'))
  home_24_biling_eng_20 <-
    readxl::read_excel(
      list_exported_xlsx_by_form(params$xlsx_download_dir, '24', 'Bilingual_English', '2020')
    )
  home_24_biling_span_20 <-
    readxl::read_excel(
      list_exported_xlsx_by_form(params$xlsx_download_dir, '24', 'Bilingual_Spanish', '2020')
    )
  
  # Extract and save the MBCDI versions
  extract_save_mcdi(
    home_12_eng_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'mbcdi',
      age_mos = '12',
      lang_grp = 'English',
      form_year = '2020'
    ),
    save_file = TRUE
  )
  
  extract_save_mcdi(
    home_12_biling_eng_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'mbcdi',
      age_mos = '12',
      lang_grp = 'Bilingual_English',
      form_year = '2020'
    ),
    save_file = TRUE
  )
  
  extract_save_mcdi(
    home_12_biling_span_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'mbcdi',
      age_mos = '12',
      lang_grp = 'Bilingual_Spanish',
      form_year = '2020'
    ),
    save_file = TRUE
  )
  
  extract_save_mcdi(
    home_18_eng_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'mbcdi',
      age_mos = '18',
      lang_grp = 'English',
      form_year = '2020'
    ),
    save_file = TRUE
  )
  
  extract_save_mcdi(
    home_18_biling_eng_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'mbcdi',
      age_mos = '18',
      lang_grp = 'Bilingual_English',
      form_year = '2020'
    ),
    save_file = TRUE
  )
  
  extract_save_mcdi(
    home_18_biling_span_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'mbcdi',
      age_mos = '18',
      lang_grp = 'Bilingual_Spanish',
      form_year = '2020'
    ),
    save_file = TRUE
  )
  
  extract_save_mcdi(
    home_24_eng_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'mbcdi',
      age_mos = '24',
      lang_grp = 'English',
      form_year = '2020'
    ),
    save_file = TRUE
  )
  
  extract_save_mcdi(
    home_24_biling_eng_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'mbcdi',
      age_mos = '24',
      lang_grp = 'Bilingual_English',
      form_year = '2020'
    ),
    save_file = TRUE
  )
  
  extract_save_mcdi(
    home_24_biling_span_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'mbcdi',
      age_mos = '24',
      lang_grp = 'Bilingual_Spanish',
      form_year = '2020'
    ),
    save_file = TRUE
  )
  
} else {
  message('2020 forms not newly exported to CSV')
}
```

## Export raw CSVs

### MB-CDI

```{r 12mos_2021_csvs}
extract_save_mcdi(
  home_12_eng_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'mbcdi',
    age_mos = '12',
    lang_grp = 'English',
    form_year = '2021'
  ),
  save_file = TRUE
)

extract_save_mcdi(
  home_12_biling_eng_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'mbcdi',
    age_mos = '12',
    lang_grp = 'Bilingual_English',
    form_year = '2021'
  ),
  save_file = TRUE
)

extract_save_mcdi(
  home_12_biling_span_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'mbcdi',
    age_mos = '12',
    lang_grp = 'Bilingual_Spanish',
    form_year = '2021'
  ),
  save_file = TRUE
)
```

```{r 18mos_2021_csvs}
extract_save_mcdi(
  home_18_eng_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'mbcdi',
    age_mos = '18',
    lang_grp = 'English',
    form_year = '2021'
  ),
  save_file = TRUE
)

extract_save_mcdi(
  home_18_biling_eng_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'mbcdi',
    age_mos = '18',
    lang_grp = 'Bilingual_English',
    form_year = '2021'
  ),
  save_file = TRUE
)

extract_save_mcdi(
  home_18_biling_span_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'mbcdi',
    age_mos = '18',
    lang_grp = 'Bilingual_Spanish',
    form_year = '2021'
  ),
  save_file = TRUE
)
```

```{r 24mos_2021_csvs}
extract_save_mcdi(
  home_24_eng_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'mbcdi',
    age_mos = '24',
    lang_grp = 'English',
    form_year = '2021'
  ),
  save_file = TRUE
)

extract_save_mcdi(
  home_24_biling_eng_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'mbcdi',
    age_mos = '24',
    lang_grp = 'Bilingual_English',
    form_year = '2021'
  ),
  save_file = TRUE
)

extract_save_mcdi(
  home_24_biling_span_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'mbcdi',
    age_mos = '24',
    lang_grp = 'Bilingual_Spanish',
    form_year = '2021'
  ),
  save_file = TRUE
)
```

### Non-MBCDI

In parallel with the MB-CDI functions above, we define some helper functions for the non-MB-CDI survey questions, and proceed as previously.

```{r non-MBCDI-helper-functions}
extract_non_mbcdi <- function(df, rename_cols = FALSE) {
  
#  df <- remove_identifiers(df)
  
  play_id_col <- (1:length(names(df)))[stringr::str_detect(names(df), 'participant_id')]
  
  # Select non-mcdi cols
  mcdi_qs <- stringr::str_detect(names(df), 'mcdi')
  non_mcdi_qs <- not(mcdi_qs)
  non_mcdi_cols <- (1:length(names(df)))[non_mcdi_qs]
    
  non_mcdi <- df %>%
    dplyr::select(., all_of(play_id_col), all_of(non_mcdi_cols))
  
  if (rename_cols) {
    non_mcdi <- dplyr::rename_with(non_mcdi, basename)
  }
  
  non_mcdi
}

extract_save_non_mbcdi <- function(df, fn, rename_cols = FALSE) {
  non_mcdi <- extract_non_mbcdi(df, rename_cols)
  readr::write_csv(non_mcdi, fn)
  message('Saved ', fn)
}
```

```{r 12mos_2021_non_mbcdi_csvs}
extract_save_non_mbcdi(
  home_12_eng_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'non_mbcdi',
    age_mos = '12',
    lang_grp = 'English',
    form_year = '2021'
  )
)

extract_save_non_mbcdi(
  home_12_biling_eng_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'non_mbcdi',
    age_mos = '12',
    lang_grp = 'Bilingual_English',
    form_year = '2021'
  )
)

extract_save_non_mbcdi(
  home_12_biling_span_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'non_mbcdi',
    age_mos = '12',
    lang_grp = 'Bilingual_Spanish',
    form_year = '2021'
  )
)
```

```{r 18mos_2021_non_mbcdi_csvs}
extract_save_non_mbcdi(
  home_18_eng_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'non_mbcdi',
    age_mos = '18',
    lang_grp = 'English',
    form_year = '2021'
  )
)

extract_save_non_mbcdi(
  home_18_biling_eng_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'non_mbcdi',
    age_mos = '18',
    lang_grp = 'Bilingual_English',
    form_year = '2021'
  )
)

extract_save_non_mbcdi(
  home_18_biling_span_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'non_mbcdi',
    age_mos = '18',
    lang_grp = 'Bilingual_Spanish',
    form_year = '2021'
  )
)
```

```{r 24mos_2021_non_mbcdi_csvs}
extract_save_non_mbcdi(
  home_24_eng_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'non_mbcdi',
    age_mos = '24',
    lang_grp = 'English',
    form_year = '2021'
  )
)

extract_save_non_mbcdi(
  home_24_biling_eng_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'non_mbcdi',
    age_mos = '24',
    lang_grp = 'Bilingual_English',
    form_year = '2021'
  )
)

extract_save_non_mbcdi(
  home_24_biling_span_21,
  make_export_csv_fn(
    export_dir = 'csv/release_1.0/raw',
    survey = 'non_mbcdi',
    age_mos = '24',
    lang_grp = 'Bilingual_Spanish',
    form_year = '2021'
  )
)
```

Update (or leave alone) the 2020 data per `params$update_2020`.

```{r 2020_non_mbcdi_csvs}
if (params$update_2020) {
  extract_save_non_mbcdi(
    home_12_eng_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'non_mbcdi',
      age_mos = '12',
      lang_grp = 'English',
      form_year = '2020'
    )
  )
  
  extract_save_non_mbcdi(
    home_12_biling_eng_21,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'non_mbcdi',
      age_mos = '12',
      lang_grp = 'Bilingual_English',
      form_year = '2020'
    )
  )
  
  extract_save_non_mbcdi(
    home_12_biling_span_21,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'non_mbcdi',
      age_mos = '12',
      lang_grp = 'Bilingual_Spanish',
      form_year = '2020'
    )
  )
  
  extract_save_non_mbcdi(
    home_18_eng_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'non_mbcdi',
      age_mos = '18',
      lang_grp = 'English',
      form_year = '2020'
    )
  )
  
  extract_save_non_mbcdi(
    home_18_biling_eng_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'non_mbcdi',
      age_mos = '18',
      lang_grp = 'Bilingual_English',
      form_year = '2020'
    )
  )
  
  extract_save_non_mbcdi(
    home_18_biling_span_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'non_mbcdi',
      age_mos = '18',
      lang_grp = 'Bilingual_Spanish',
      form_year = '2020'
    )
  )
  
  extract_save_non_mbcdi(
    home_24_eng_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'non_mbcdi',
      age_mos = '24',
      lang_grp = 'English',
      form_year = '2020'
    )
  )
  
  extract_save_non_mbcdi(
    home_24_biling_eng_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'non_mbcdi',
      age_mos = '24',
      lang_grp = 'Bilingual_English',
      form_year = '2020'
    )
  )
  
  extract_save_non_mbcdi(
    home_24_biling_span_20,
    make_export_csv_fn(
      export_dir = 'csv/release_1.0/raw',
      survey = 'non_mbcdi',
      age_mos = '24',
      lang_grp = 'Bilingual_Spanish',
      form_year = '2020'
    )
  )
} else {
  message('2020 data not updated.')
}
```

# Clean non-MB-CDI data




## Remove personally identifying fields.

The non-MB-CDI data contain personal identifiers. The following helper function detects and helps remove them.

```{r define-remove-identifiers}
remove_identifiers <- function(df) {
  contains_name <- stringr::str_detect(names(df), 'name')
  contains_address <- stringr::str_detect(names(df), 'address')
  contains_phone <- stringr::str_detect(names(df), 'phone')
  contains_email <- stringr::str_detect(names(df), 'email')
  contains_birthdate <- stringr::str_detect(names(df), 'birthdate')
  contains_first <- stringr::str_detect(names(df), 'first[12]?')
  contains_last <- stringr::str_detect(names(df), 'last[12]?')
  contains_city <- stringr::str_detect(names(df), 'city')
  contains_year <- stringr::str_detect(names(df), 'year[12]?')
  contains_month <- stringr::str_detect(names(df), 'month[12]?')
  contains_day <- stringr::str_detect(names(df), 'day[12]?')
  
  identifiable_data <- contains_name | contains_address | 
    contains_phone | contains_email | contains_birthdate | contains_first |
    contains_last | contains_city | contains_year | contains_month | contains_day
  
  identifiable_cols <- (1:length(names(df)))[identifiable_data]
  
  df_deidentified <- df %>%
    dplyr::select(., -all_of(identifiable_cols))
  
  df_deidentified
}

remove_identifiers_reexport <- function(in_file_path, out_dir = file.path(params$csv_export_dir, 'identifiers_removed')) {
  df <- readr::read_csv(in_file_path, show_col_types = FALSE)
  
  df_deid <- remove_identifiers(df)
  
  out_file_path <- file.path(out_dir, basename(in_file_path))
  readr::write_csv(df_deid, out_file_path)
  message('Deidentified file written: ', out_file_path)
}
```

```{r bulk-deidentify-and-write}
raw_csvs <- list.files(file.path(params$csv_export_dir, 'raw'), 'non_mbcdi', full.names = TRUE)
purrr::map(raw_csvs, remove_identifiers_reexport)
```

## Fix variable alignment

The explorations documented in `gather_clean_visit.html` indicate that there are some column type specification errors that arise in trying to re-import the CSVs *en masse*, but let's first determine if the files have the same number of columns and the same names.

```{r}
import_extract_names <- function(csv_path) {
  df <- readr::read_csv(csv_path, show_col_types = FALSE)
  names(df)
}

non_mbcdi_clean_fns <- list.files('csv/release_1.0/identifiers_removed', '\\.csv', full.names = TRUE)
```

Some initial explorations indicate that the `non_mbcdi_12_english_2021.csv` and `non_mbcdi_12_english_2020.csv` files have an extra variable. The differences arise beginning at column 247. The easiest but hacky fix is to delete these columns.

```{r}
# NOTE the colClasses = 'character' forces read.csv() to read all data fields as strings. This solves some
# problems with importing the data and the automated assumptions made about specific data types.

read_PLAY_csv <- function(fn, last_col = 246) {
  df <- read.csv(fn, colClasses = 'character')
  df <- df[,1:last_col]
}

PLAY_non_mbcdi_all <- purrr::map_df(non_mbcdi_clean_fns, read_PLAY_csv)
```

## Remove redundant variable name text

Using `xfun::gsub_file()` we can trim some of the redundancies across the variable names.

```{r export-aggregate}
aggregate_fn <- file.path(params$csv_export_dir, 'aggregate', 'PLAY_non_mbcdi_all.csv')

readr::write_csv(PLAY_non_mbcdi_all, aggregate_fn)
xfun::gsub_file(aggregate_fn,
                  'group_combinedquestionnaires.',
                  '')
xfun::gsub_file(aggregate_fn,
                  'group_homevisitquestionnaires.',
                  '')
xfun::gsub_file(aggregate_fn,
                'group_',
                '')
```

## Add Databrary-related metadata

```{r add-Databrary-metadata}
create_save_kobo_db_merge_csv("csv/release_1.0/aggregate/PLAY_non_mbcdi_all.csv", "csv/release_1.0/aggregate/PLAY_non_mbcdi_all_merge.csv")
```

# Clean-up

## Log-out of Databrary

```{r}
databraryapi::logout_db()
```

