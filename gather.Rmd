---
title: "Gather KoBoToolbox"
subtitle: "Version `r Sys.time()`"
output: html_notebook
---

# Purpose

This document describes Rick Gilmore's explorations of the process for downloading and cleaning PLAY Project data from the KoBoToolbox server.

# Setup

The PLAY Project uses KoBoToolbox to collect data from parents and researchers using a tablet application.

The data are stored in an account on <https://kf.kobotoolbox.org>. The login credentials for that account are shared among the PLAY Project staff.

To access the site's API programmatically, an API key was downloaded and added to the local `.Renviron` file.

To test whether the local system has the API key installed, run the following command `Sys.getenv("KOBO_API_KEY")`.

With the API key installed, several custom functions in `R/kobo_files.R` can be run.

## Load/source helper functions

```{r}
source("R/kobo_export.R")
```

## Install dependencies

The helper functions require several external packages. To confirm that these are installed, run the following chunk.

```{r}
install_kobo_packages()
```

## Confirm connection to KoBoToolbox server

We now confirm that we can access data from the server.

```{r}
kb_df <- list_kobo_data()

str(kb_df)
```

This function returns data frame that information about *all* of the forms we have created thus far.

# Exporting files

We are now ready to export data files.

## Demographic questionnaire

We'll focus on the Demographic Questionnaire.

```{r}
kb_demog <- kb_df %>%
  dplyr::filter(., stringr::str_detect(title, "[Dd]emographic"))

kb_demog
```
It looks like there are three of these. Let's download and save the 2nd one, since from the description, it looks like the newer one.
 
```{r}
saved_fn <- retrieve_save_xls_export(2, kb_demog)
```

# Import XLSX

We'll use the `readxl` package to load the saved XLSX file.

```{r}
demog <- readxl::read_excel(saved_fn)
```

Oh, no. The file can't be read. Back to the drawing board.

Let's list just the questions asked.

```{r}
names(demog)
```

We can use this list of column/variable names to derive a list of those to keep and those to discard. Here's a very crude first pass.

```{r}
demog_selected_1 <- demog %>%
  dplyr::select(., matches('[A-J]{1}[0-9]{1}[a-z]?\\.'))
```

**I do not print the output because the file contains identifiable information.**

This lists the variables that were selected.

```{r}
select_demog <- stringr::str_detect(names(demog), '[A-Z]{1}[0-9]{1}[a-z]?\\.') |
  stringr::str_detect(names(demog), 'Street Address') |
  stringr::str_detect(names(demog), 'City') |
  stringr::str_detect(names(demog), 'State') |
  stringr::str_detect(names(demog), 'Enter a number') | # For birthweight ounces
  stringr::str_detect(names(demog), 'c_today') |
  stringr::str_detect(names(demog), '_full name_ of the person')
```

```{r}
names(demog[select_demog])
```

```{r}
these_demog <- demog[, select_demog]
readr::write_csv(these_demog, 'csv/aggregate/PLAY_all_screen.csv')
```

## Post-visit notes

```{r}
save_xlsx_export_from_url(url = get_xls_url_for_play_form(id_string = kb_df$uid[7]))
```

```{r}
post_visit <- readxl::read_excel('xlsx/PLAY_Post-Visit_Notes_2020-03-04_-_all_versions_-_labels_-_2021-02-08-16-20-56.xlsx')
```
```{r}
select_post_visit <- stringr::str_detect(names(post_visit), 'Please select _all_')
# Kasey will likely rename the field headers here so we can select them more programmatically.
```

## Home visit questionnaires

```{r}
save_xlsx_export_from_url(url = get_xls_url_for_play_form(id_string = kb_df$uid[2]))

home_visit_all <- readxl::read_excel('xlsx/PLAY%20Home%20Questionnaires%20(12%20English)%20-%20all%20versions%20-%20labels%20-%202020-01-08-20-20-26.xlsx')
```

