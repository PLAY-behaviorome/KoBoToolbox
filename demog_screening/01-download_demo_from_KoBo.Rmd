---
title: "KoBoToolbox Demographics Data Download"
subtitle: "Version `r Sys.time()`"
author: Rick Gilmore
output: 
  html_document:
    code_folding: show
    self_contained: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
params:
  xlsx_download_dir: 'data/xlsx/release_1.0'
  download_xlsx: true
  path_to_root_dir: '..'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

This document exports demographics/recruiting survey data from KoBoToolbox and saves it in "`r params$xlsx_download_dir`".

# Setup

The PLAY Project uses KoBoToolbox to collect data from parents and researchers using a tablet application. 

## Authentication

The data are stored in an account on <https://kf.kobotoolbox.org>. The login credentials for that account are shared among the PLAY Project staff. To access the site's API programmatically, an API key was downloaded and added to the local `~/.Renviron` file. To test whether the local system has the API key installed, run the following command `Sys.getenv("KOBO_API_KEY")`. With the API key installed, several custom functions in `R/kobo_export.R` can be run.

### Check KoBo API Key

```{r check-api-key}
kb_api <- Sys.getenv("KOBO_API_KEY")
if ((length(kb_api) != 1) || (!is.character(kb_api))) {
  stop("`KOBO_API_KEY` not installed in .Renviron")
} else {
  message("`KOBO_API_KEY` installed.")
}
```

## Load/source helper functions

```{r source-helpers}
source(file.path(params$path_to_root_dir, "R", "kobo_export.R"))
```

## Install dependencies

The helper functions require several external packages. To confirm that these are installed, run the following chunk.

```{r install-dependencies}
install_kobo_packages()
```

# Download data

```{r list-kobo-forms}
kb_df <- list_kobo_data()
if ((dim(kb_df) < 1) || (!is.data.frame(kb_df))) {
  stop("Error in selecting surveys from KoBoToolbox.")
}

# Restrict to surveys collected at home
kb_demog <- kb_df %>%
  dplyr::filter(., stringr::str_detect(title, "Demographic"))

if ((dim(kb_demog) < 1) || (!is.data.frame(kb_demog))) {
  stop("Error in selecting demographics surveys from KoBoToolbox.")
}
```

## Download demog data

```{r download-demog}
retrieve_save_xls_export(1, kb_demog, file.path(params$path_to_root_dir, params$xlsx_download_dir))
retrieve_save_xls_export(2, kb_demog, file.path(params$path_to_root_dir, params$xlsx_download_dir))
retrieve_save_xls_export(3, kb_demog, file.path(params$path_to_root_dir, params$xlsx_download_dir))
```
