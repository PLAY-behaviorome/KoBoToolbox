---
title: 'PLAY Release 1.0: Surveys'
subtitle: "Version `r Sys.time()`"
author: Rick Gilmore
output: 
  html_document:
    code_folding: hide
    self_contained: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
params:
  kobo_csv_fn: 'tmp/PLAY_non_mbcdi_all_merge.csv'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

This document summarizes the workflow for the PLAY 1.0 data release related to the non-MBCDI survey data.

# Setup

The user should authenticate to Databrary using `databraryapi::login_db()` prior to knitting this document.

Import helper functions.

```{r}
source("R/kobo_databrary_integration.R")

library(tidyverse) # for %>% pipe
```

# Import & merge data

We import data from KoBoToolbox and from Databrary and merge the files.

```{r import-kobo-merge-w-databrary}
play_merge <- readr::read_csv(params$kobo_csv_fn, show_col_types = FALSE)
```

# Visualize

## Demographic data summaries

### Age group by QA status

```{r}
xtabs(formula = ~ group.name + age_group, data = play_merge)
```

### Sex by age group

```{r}
xtabs(formula = ~ child_sex + age_group, data = play_merge)
```

### QA status by site

```{r}
xtabs(formula = ~ group.name + site_id, data = play_merge)
```

## Links to Databrary sessions

```{r}
play_selected <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group.name, databrary_url)

play_selected %>%
  dplyr::arrange(., group.name, age_group) %>%
  knitr::kable(., caption = "Selected PLAY data") %>%
  kableExtra::kable_material(c("striped", "hover"))
```

## Locomotor milestones

### Crawl onset

```{r}
play_loco <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group.name, databrary_url,
                locomotor_milestones.who_walk.who_walk_onset_mo,
                locomotor_milestones.k_walk.k_walk_onset_mo,
                locomotor_milestones.crawl_onset.crawl_onset_mo) %>%
  dplyr::rename(., walk_mos_who = locomotor_milestones.who_walk.who_walk_onset_mo,
                walk_mos_kea = locomotor_milestones.k_walk.k_walk_onset_mo,
                crawl_mos = locomotor_milestones.crawl_onset.crawl_onset_mo)

play_loco %>%
  ggplot(.) +
  aes(crawl_mos, fill = child_sex) +
  geom_histogram()
```

### Walk onset

```{r}
play_loco %>%
  ggplot(.) +
  aes(walk_mos_kea, fill = child_sex) +
  geom_histogram()
```

```{r}
play_loco %>%
  ggplot(.) +
  aes(walk_mos_who, fill = child_sex) +
  geom_histogram()
```

```{r}
play_loco %>%
  ggplot(.) +
  aes(walk_mos_who, walk_mos_kea, color = child_sex) +
  geom_point() +
  theme(legend.position="bottom") -> walk_p

ggExtra::ggMarginal(walk_p, play_loco, walk_mos_who, walk_mos_kea, 
                    type = "density", margins = "both", groupColour = TRUE, groupFill = TRUE)
```

```{r}
play_loco %>%
  dplyr::arrange(., group.name, walk_mos_kea) %>%
  dplyr::select(., group.name, child_sex, crawl_mos, walk_mos_kea, walk_mos_who, databrary_url) %>%
  knitr::kable(., caption = "Selected PLAY locomotor data") %>%
  kableExtra::kable_material(c("striped", "hover"))
```

## PHQ4

The Patient Health Questionnaire (PHQ-4) data should be changed into an ordered factor.

```{r}
phq4_levels <- c('notatall', 'severaldays', 'morethanhalf', 'nearly')

play_phq4 <- play_merge %>%
  dplyr::select(., age_group, child_sex,
                 health.phq4.phq4_nervous, 
                 health.phq4.phq4_worrying,
                 health.phq4.phq4_littleinterest,
                health.phq4.phq4_down) %>%
  dplyr::rename(., phq4_nervous = health.phq4.phq4_nervous,
                phq4_worrying = health.phq4.phq4_worrying,
                phq4_littleinterest = health.phq4.phq4_littleinterest,
                phq4_down = health.phq4.phq4_down) %>%
  dplyr::mutate(., phq4_nervous = factor(phq4_nervous, levels = phq4_levels, ordered = TRUE),
                phq4_worrying = factor(phq4_worrying, levels = phq4_levels, ordered = TRUE),
                phq4_littleinterest = factor(phq4_littleinterest, levels = phq4_levels, ordered = TRUE),
                phq4_down = factor(phq4_down, levels = phq4_levels, ordered = TRUE))
```

### "Nervous"

```{r}
l_nervous <- likert::likert(as.data.frame(play_phq4$phq4_nervous))
plot(l_nervous)
```

### "Worrying"

```{r}
l_worrying <- likert::likert(as.data.frame(play_phq4$phq4_worrying))
plot(l_worrying)
```

### "Little interest"

```{r}
l_littleinterest <- likert::likert(as.data.frame(play_phq4$phq4_littleinterest))
plot(l_littleinterest)
```

### "Down"

```{r}
l_down <- likert::likert(as.data.frame(play_phq4$phq4_down))
plot(l_down)
```

## Health

### Feeding

```{r}
feeding <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group.name, databrary_url,
                health.feeding_nutrition.breastfeed,
                health.feeding_nutrition.solidfood_age) %>%
  dplyr::rename(., breastfeed = health.feeding_nutrition.breastfeed,
                solid_food_mos = health.feeding_nutrition.solidfood_age)
```

```{r}
xtabs(formula = ~ child_sex + breastfeed, data = feeding)
```

```{r}
feeding %>%
  ggplot(.) +
  aes(x = solid_food_mos, color = child_sex, fill = child_sex) +
  geom_histogram()
```

### Smoking/drinking

```{r}
smoking_drinking <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group.name, databrary_url,
                health.smoking.pregnant_smoking,
                health.drinking.pregnant_drinking) %>%
  dplyr::rename(., preg_smoking = health.smoking.pregnant_smoking,
                preg_drinking = health.drinking.pregnant_drinking)

xtabs(formula = ~ preg_smoking + preg_drinking, smoking_drinking)
```

### Sleeping position

```{r}
sleeping_pos <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group.name, databrary_url,
                health.general_health.child_sleeping_position ) %>%
  dplyr::rename(., child_sleeping_position = health.general_health.child_sleeping_position) 

xtabs(formula = ~ child_sleeping_position, data = sleeping_pos)
```

### Child health rating

```{r}
child_health <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group.name, databrary_url,
                health.general_health.child_health ) %>%
  dplyr::rename(., child_health_rating = health.general_health.child_health) %>%
  dplyr::mutate(., child_health_rating = factor(child_health_rating, levels = c('good', 'verygood', 'excellent'), ordered = TRUE))


plot(likert::likert(as.data.frame(child_health$child_health_rating)))
```

### See medical specialist

```{r}
med_specialist <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group.name, databrary_url,
                health.general_health.child_medical_specialist,
                health.general_health.comments_child_medical_special) %>%
  dplyr::rename(., see_med_specialist = health.general_health.child_medical_specialist,
                med_specialist_reason = health.general_health.comments_child_medical_special)

xtabs(formula = ~ age_group + see_med_specialist, data = med_specialist)
```

#### Med specialist reasons

```{r}
med_specialist %>%
  dplyr::filter(., (!is.na(med_specialist_reason))) %>%
  dplyr::select(., med_specialist_reason)
```

### Vaccination status

```{r}
vaccination <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group.name, databrary_url,
                health.general_health.child_vaccination ) %>%  
  dplyr::rename(., child_vaccinated = health.general_health.child_vaccination )

xtabs(formula = ~ age_group + child_vaccinated, data = vaccination)
```

## Media use

```{r}
media_use_cols <- stringr::str_detect(names(play_merge), 'mediause')
media_use_col_index <- (1:length(names(play_merge)))[media_use_cols]

media_use <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group.name, databrary_url,
                all_of(media_use_col_index)) %>%
  dplyr::rename(., have_tv =  mediause.home_technology.tv,
                have_computer = mediause.home_technology.computer,
                have_tablet = mediause.home_technology.ipad,
                have_videogame = mediause.home_technology.videogame,
                have_educationalgame = mediause.home_technology.educationalgame)
```

```{r}
xtabs(formula = ~ have_tv, data = media_use)
xtabs(formula = ~ have_computer, data = media_use)
#xtabs(formula = ~ mediause.home_technology.smartphone, data = media_use)
xtabs(formula = ~  have_tablet, data = media_use)
xtabs(formula = ~  have_videogame, data = media_use)
xtabs(formula = ~ have_educationalgame, data = media_use)
```

**Note**: The KoBoToolbox export does not generate a column for `smartphone` even though that is one of the permitted values in `mediause.home_technology`. We can generate that *post hoc*, however.

```{r}
media_use$mediause.home_technology
```

## Pets

```{r}
pets <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group.name, databrary_url,
                pets.pets_at_home,
                pets.pets_types_number,
                pets.pets_indoors_outdoors,
                pets.comments_pets) %>%
  dplyr::rename(., pets_at_home = pets.pets_at_home,
                pets_where_live = pets.pets_indoors_outdoors) %>%
  dplyr::mutate(., have_dog = stringr::str_detect(pets.pets_types_number, '[dD]og'),
                have_cat = stringr::str_detect(pets.pets_types_number, '[cC]at'),
                have_bird = stringr::str_detect(pets.pets_types_number, '[bB]ird'),
                have_fish = stringr::str_detect(pets.pets_types_number, '[fF]ish'))
```

```{r}
xtabs(formula = ~ pets_at_home + pets_where_live, data = pets)
```

Focusing on families that *have* pets at home.

```{r}
pets %>%
  dplyr::filter(., pets_at_home == "yes") %>%
  dplyr::select(., pets_at_home, have_dog, have_cat, have_bird, have_fish)
```

