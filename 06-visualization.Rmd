# Visualizations {-}

## Recruiting calls data {-}

Cumulative screening/recruiting calls by site.

```{r}
library(targets)
library(tidyverse)
library(forcats)
```

```{r load-screening-df}
tar_load(screen_df)
df <- add_n_calls_to_demog(screen_df)
```

```{r, fig.cap="Cumulative screening calls by year and site"}
plot_call_timeseries(df)
```

Number of screening calls by site.

```{r, fig.cap="Cumulative screening calls by year and site"}
calls_by_site_plot <- function(df) {
  require(dplyr)
  df %>%
    filter(., !is.na(site_id)) %>%
    ggplot(.) +
    aes(fct_infreq(site_id), fill = site_id) +
    geom_bar() +
    theme(axis.text.x = element_text(
      angle = 90,
      vjust = 0.5,
      hjust = 1
    )) + # Rotate text
    labs(x = "site") +
    theme(legend.position = "none")
}

# df <- screen_df %>%
#   group_by(site_id) %>%
#   summarize(calls_per_site = n()) %>%
#   arrange(desc(calls_per_site))

calls_by_site_plot(screen_df)
```

### Demographics {-}

Child age in months (`child_age_mos`) by `child_sex`.

```{r, fig.cap="Histogram of child age at time of recruiting call."}
screen_df %>%
  dplyr::filter(., !is.na(child_age_mos), !is.na(child_sex)) %>%
  ggplot() +
  aes(child_age_mos, fill = child_sex) +
  geom_histogram(bins = 50)
```

::: {.rmdnote}
Some of the code to clean the `screen_df` variables could be incorporated into an earlier stage of the workflow.
:::

Language(s) spoken to child by `child_sex`.

```{r}
df <- screen_df %>%
  dplyr::mutate(., language_to_child = stringr::str_replace_all(language_to_child, " ", "_"))
xtabs(formula = ~ child_sex + language_to_child, data = df)
```

Mother race and ethnicity.

```{r}
df <- screen_df %>%
  dplyr::mutate(
    .,
    mother_race = dplyr::recode(
      mother_race,
      morethanone = "more_than_one",
      americanindian = "american_indian"
    ),
    mother_ethnicity = dplyr::recode(
      mother_ethnicity,
      hispanic_or_la = "hispanic",
      not_hispanic_o = "not_hispanic",
      nothispanic = "not_hispanic"
    )
  )
xtabs(formula = ~ mother_race + mother_ethnicity,
      data = df)
```

### Recruiting locations {-}

::: {.rmdimportant}
For privacy reasons, we do not expose or share address information.
The following commands retrieve address information from the raw data files and then retrieve geographic information using the U.S. Census API.
In the future, we may decide to link an individual respondent's information to their County.
:::

Create helper functions to make a tibble with a repondent's address.

```{r}
make_address <- function(i, df, survey_type = 'new') {
  require(dplyr)
  require(tibble)
  this_row <- df[i, ]
  if (survey_type == 'new') {
  out_df <- this_row %>%
    dplyr::select(
      .,
      addr1 = `play_demo_questionnaire/group_contact_info/group_address/parent_address_1`,
      addr2 = `play_demo_questionnaire/group_contact_info/group_address/parent_address_2`,
      city = `play_demo_questionnaire/group_contact_info/group_address/city`,
      state = `play_demo_questionnaire/group_contact_info/group_address/state`
    )  
  } else {
  out_df <- this_row %>%
    dplyr::select(
      .,
      addr1 = `play_phone_questionnaire/group_contact_info/group_address/parent_address_1`,
      addr2 = `play_phone_questionnaire/group_contact_info/group_address/parent_address_2`,
      city = `play_phone_questionnaire/group_contact_info/group_address/city`,
      state = `play_phone_questionnaire/group_contact_info/group_address/state`)
    
  }

  if ((!is.na(out_df$addr1) && (!is.na(out_df$city) && (!is.na(out_df$state))))) {
    addr <- with(out_df, paste0(addr1, ", ", city, ", ", state))
    tibble(singlelineaddr = addr)
  } else {
    NULL
  }
}

make_addresses <- function(df, survey_type) {
  require(purrr)
  purrr::map_df(1:dim(df)[1], make_address, df, survey_type)
}
```

Create aggregate data file with address information for the three screening data files.

```{r}
fns <- list.files("data/csv/screening",full.names = TRUE)

df1 <- readr::read_csv(fns[1], show_col_types = FALSE)
df2 <- readr::read_csv(fns[2], show_col_types = FALSE)
df3 <- readr::read_csv(fns[3], show_col_types = FALSE)

ad1 <- make_addresses(df1, 'old')
ad2 <- make_addresses(df2, 'new')
ad3 <- make_addresses(df3, 'new')

add <- rbind(ad1, ad2, ad3)
```

Helper function to gather Census geographic information in bulk.

```{r}
get_multiple_census_geos <- function(addrs) {
  require(tidygeocoder)
  addrs %>% tidygeocoder::geocode(
    address = singlelineaddr,
    method = "census",
    full_results = TRUE,
    api_options = list(census_return_type = 'geographies')
  )
}
```

Retrieve the Census geographic information.

```{r}
geos <- get_multiple_census_geos(add)
```

Helper function to plot lat and long of recruiting sites on a U.S. map.

```{r, message=FALSE}
plot_screening_sites <- function(geo_df) {
  require(ggmap)
  require(dplyr)
  require(ggplot2)
  
  geo_df <- geo_df %>%
    dplyr::filter(., !is.na(lat), !is.na(long))
  
  usa <- ggmap::get_map("USA", zoom=4)
  usa %>%
    ggmap::ggmap() +
    ggplot2::geom_point(data = geo_df, aes(x = long, y = lat))
}
```

Plot the map.

```{r, fig.cap = "Families contacted by location"}
plot_screening_sites(geos)
```
 
## Home visit data {-}

```{r}
targets::tar_load(home_visit_df)
```

### Demographics {-}

Child age in months (`age_group`) by `child_sex`.

Note: The child's exact age in months is part of the Databrary-related data. 
That is on the work plan.

```{r}
home_visit_df %>%
  dplyr::filter(., !is.na(age_group), !is.na(child_sex)) %>%
  ggplot() +
  aes(age_group, fill = child_sex) +
  geom_bar() +
  theme(legend.position="bottom") +
  theme(legend.title = element_blank())
```

### Language exposure {-}

```{r}
df <- home_visit_df %>%
  dplyr::mutate(., language_child = stringr::str_replace_all(language_child, " ", "_"))
xtabs(formula = ~ child_sex + language_child, data = df)
```

### Locomotor milestones {-}

#### Crawl onset {-}

```{r}
play_loco <- home_visit_df %>%
  dplyr::select(., age_group, child_sex, language_child,
                locomotor_milestones.who_walk.who_walk_onset_mo,
                locomotor_milestones.k_walk.k_walk_onset_mo,
                locomotor_milestones.crawl_onset.crawl_onset_mo) %>%
  dplyr::rename(., walk_mos_who = locomotor_milestones.who_walk.who_walk_onset_mo,
                walk_mos_kea = locomotor_milestones.k_walk.k_walk_onset_mo,
                crawl_mos = locomotor_milestones.crawl_onset.crawl_onset_mo) %>%
  dplyr::mutate(., walk_mos_who = as.numeric(walk_mos_who),
                walk_mos_kea = as.numeric(walk_mos_kea),
                crawl_mos = as.numeric(crawl_mos))

```

```{r fig-crawl-onset-hist, fig.cap="Age of crawling onset (mos) by sex"}
play_loco %>%
  ggplot(.) +
  aes(crawl_mos, fill = child_sex) +
  geom_histogram(bins = 12) +
  theme(legend.position="bottom") +
  theme(legend.title = element_blank())
```

### Walk onset {-}

```{r fig-walk-mos-kea, fig.cap="Age (mos) of walking onset (KEA criteria) by sex"}
play_loco %>%
  ggplot(.) +
  aes(walk_mos_kea, fill = child_sex) +
  theme(legend.position="bottom") +
  geom_histogram(bins = 10)
```

```{r fig-walk-mos-who, fig.cap="Age (mos) of walking onset (WHO criteria) by sex"}
play_loco %>%
  ggplot(.) +
  aes(walk_mos_who, fill = child_sex) +
  geom_histogram(bins=12) +
  theme(legend.position="bottom") +
  theme(legend.title = element_blank())
```

```{r fig-walk-mos-kea-who, fig.cap="Walking onset by WHO vs. KEA criteria"}
play_loco %>%
  ggplot(.) +
  aes(walk_mos_who, walk_mos_kea, color = child_sex) +
  geom_point() +
  geom_smooth(method = "lm") +
  xlim(8, 18) +
  ylim(8, 18) +
  theme(legend.position="bottom") +
  theme(aspect.ratio = 1) +
  theme(legend.title = element_blank()) -> walk_p

ggExtra::ggMarginal(walk_p, play_loco, walk_mos_who, walk_mos_kea, 
                    type = "density", margins = "both", groupColour = TRUE, groupFill = TRUE)
```

```{r fig-walk-mos-kea-crawl-mos, fig.cap="Walking onset vs. Crawling"}
play_loco %>%
  ggplot(.) +
  aes(crawl_mos, walk_mos_kea, color = child_sex) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme(legend.position="bottom") +
  theme(aspect.ratio = 1) +
  theme(legend.title = element_blank()) -> walk_p

ggExtra::ggMarginal(walk_p, play_loco, walk_mos_who, walk_mos_kea, 
                    type = "density", margins = "both", groupColour = TRUE, groupFill = TRUE)
```

### Health {-}

#### Feeding {-}

```{r}
feeding <- home_visit_df %>%
  dplyr::select(., age_group, child_sex, language_child,
                health.feeding_nutrition.breastfeed,
                health.feeding_nutrition.solidfood_age) %>%
  dplyr::rename(., breastfeed = health.feeding_nutrition.breastfeed,
                solid_food_mos = health.feeding_nutrition.solidfood_age) %>%
  dplyr::mutate(., solid_food_mos = as.numeric(solid_food_mos))
```

```{r}
xtabs(formula = ~ child_sex + breastfeed, data = feeding)
```

```{r}
feeding %>%
  ggplot(.) +
  aes(x = solid_food_mos, color = child_sex, fill = child_sex) +
  geom_histogram(bins = 15)
```

#### Smoking/drinking {-}

```{r}
smoking_drinking <- home_visit_df %>%
  dplyr::select(., age_group, child_sex, language_child,
                health.smoking.pregnant_smoking,
                health.drinking.pregnant_drinking) %>%
  dplyr::rename(., preg_smoking = health.smoking.pregnant_smoking,
                preg_drinking = health.drinking.pregnant_drinking)

xtabs(formula = ~ preg_smoking + preg_drinking, smoking_drinking)
```

#### Sleeping position {-}

```{r}
sleeping_pos <- home_visit_df %>%
  dplyr::select(., age_group, child_sex, language_child,
                health.general_health.child_sleeping_position) %>%
  dplyr::rename(., child_sleeping_position = health.general_health.child_sleeping_position) 

xtabs(formula = ~ child_sleeping_position, data = sleeping_pos)
```

## Post-visit data

We load the post-visit survey data.

```{r load-post-visit-df}
tar_load(post_visit_df)

dim(post_visit_df)
```

::: {.rmdnote}
Cleaning this data is set aside for future work.
:::