---
title: "Clean merged aggregate for sharing"
subtitle: "Version `r Sys.time()`"
author: Rick Gilmore
output: 
  html_document:
    code_folding: show
    self_contained: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
params:
  release_version: 'release_1.0'
  in_fn: 'PLAY_non_mbcdi_all_databrary.csv'
  out_fn: 'PLAY_non_mbcdi_all_share.csv'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

This document imports a file that contains the merged and aggregated PLAY data, does additional cleaning on the file,  saves the aggregated file to a new `../aggregate` directory. 

To render, run `rmarkdown::render("07-clean_aggregate.Rmd".

# Setup

We load required libraries.

```{r}
library(tidyverse)
```

## Generate and check file paths

```{r}
csv_input_dir <- file.path('csv', params$release_version, 'aggregate')
if (!dir.exists(csv_input_dir)) {
  stop('Directory not found: `', csv_input_dir, '`')
}

csv_save_dir <- file.path('csv', params$release_version, 'aggregate')
if (!dir.exists(csv_save_dir)) {
  stop('Directory not found: `', csv_save_dir, '`')
  
}

in_file <- file.path(csv_input_dir, params$in_fn)
if (!file.exists(in_file)) {
  stop('File not found: `', in_file, '`')
}
```

# File processing

## Import

```{r import}
play <-
  read_csv(in_file,
           show_col_types = FALSE)
```

## Generate list of fields to delete

```{r}
site_sub_ids <- str_detect(names(play), 'site|subject_number')
notes_instructions_calc <- str_detect(names(play), 'note|instructions|calc')
start_end <- str_detect(names(play), 'start|end')
other_dates <- str_detect(names(play), 'date')
acknowledge <- str_detect(names(play), 'acknowledge')
version <- str_detect(names(play), 'version')
databrary_hooks <- str_detect(names(play), 'session|url|participant.ID|vol_id')
state <- str_detect(names(play), 'state')

remove_these <- site_sub_ids |
  notes_instructions_calc | 
  start_end | 
  other_dates | 
  acknowledge | 
  version | 
  databrary_hooks | 
  state
remove_cols <- (1:length(names(play)))[remove_these]

play_clean_1 <- play %>%
  dplyr::select(., -all_of(remove_cols))
```

## Clean-up Databrary field names

```{r}
play_clean_2 <- play_clean_1 %>%
  dplyr::rename(., child_race = participant.race,
                child_ethnicity = participant.ethnicity,
                child_disability = participant.disability,
                child_language = participant.language,
                exclusion_reason = exclusion.reason,
                qa_group = group.name,
                setting = context.setting,
                country = context.country,
                context_language = context.language)
```

## Export

```{r}
if (dir.exists(csv_save_dir)) {
  write_csv(play_clean_2, file.path(csv_save_dir, params$out_fn))
} else {
  warning('Directory not found: `', csv_save_dir, '`')
  warning('File not saved.')
}
```
