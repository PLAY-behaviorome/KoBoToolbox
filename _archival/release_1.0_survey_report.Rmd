---
title: 'PLAY Release 1.0: Surveys'
subtitle: "Version `r Sys.time()`"
author: Rick Gilmore
output: 
  html_document:
    code_folding: hide
    self_contained: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
params:
  csv_dir: 'csv'
  release: 'release_1.0'
  kobo_csv_fn: 'csv/release_1.0/aggregate/PLAY_non_mbcdi_all_databrary.csv'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Purpose

This document summarizes the workflow for the PLAY 1.0 data release related to the non-MBCDI survey data.

# Setup

The user should authenticate to Databrary using `databraryapi::login_db()` prior to knitting this document.

Import helper functions.

```{r}
source("R/kobo_databrary_integration.R")
library(tidyverse) # for %>% pipe
```

# Import & merge data

We import data from KoBoToolbox and from Databrary and merge the files.

```{r import-kobo-merge-w-databrary}
data_dir <- file.path(params$csv_dir, params$release)
if (!dir.exists(data_dir)) stop("Cannot find data directory `, data_dir, '`")

if (!file.exists(params$kobo_csv_fn)) stop('Cannot open file `', params$kobo_csv_fn, '`')
play_merge <- readr::read_csv(params$kobo_csv_fn, show_col_types = FALSE)
```

# Visualize

## Demographic data summaries

### QA status overall

```{r}
xtabs(formula = ~ group_name, data = play_merge)
```

### Age group by QA status

```{r}
xtabs(formula = ~ group_name + age_group, data = play_merge)
```

### Sex by age group

```{r}
xtabs(formula = ~ child_sex + age_group, data = play_merge)
```

### QA status by site

```{r}
xtabs(formula = ~ group_name + site_id, data = play_merge)
```

## Links to Databrary sessions

```{r}
play_selected <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group_name, databrary_url)

play_selected %>%
  dplyr::arrange(., group_name, age_group) %>%
  knitr::kable(., caption = "Selected PLAY data") %>%
  kableExtra::kable_material(c("striped", "hover"))
```

## Locomotor milestones

### Crawl onset

```{r}
play_loco <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group_name, databrary_url,
                locomotor_milestones.who_walk.who_walk_onset_mo,
                locomotor_milestones.k_walk.k_walk_onset_mo,
                locomotor_milestones.crawl_onset.crawl_onset_mo) %>%
  dplyr::rename(., walk_mos_who = locomotor_milestones.who_walk.who_walk_onset_mo,
                walk_mos_kea = locomotor_milestones.k_walk.k_walk_onset_mo,
                crawl_mos = locomotor_milestones.crawl_onset.crawl_onset_mo)

play_loco %>%
  ggplot(.) +
  aes(crawl_mos, fill = child_sex) +
  geom_histogram(bins = 12)
```

### Walk onset

```{r}
play_loco %>%
  ggplot(.) +
  aes(walk_mos_kea, fill = child_sex) +
  geom_histogram(bins = 10)
```

```{r}
play_loco %>%
  ggplot(.) +
  aes(walk_mos_who, fill = child_sex) +
  geom_histogram(bins=12)
```

```{r}
play_loco %>%
  ggplot(.) +
  aes(walk_mos_who, walk_mos_kea, color = child_sex) +
  geom_point() +
  xlim(8, 18) +
  ylim(8, 18) +
  theme(legend.position="bottom") -> walk_p

ggExtra::ggMarginal(walk_p, play_loco, walk_mos_who, walk_mos_kea, 
                    type = "density", margins = "both", groupColour = TRUE, groupFill = TRUE)
```

```{r}
play_loco %>%
  dplyr::arrange(., group_name, walk_mos_kea) %>%
  dplyr::select(., group_name, child_sex, crawl_mos, walk_mos_kea, walk_mos_who, databrary_url) %>%
  knitr::kable(., caption = "Selected PLAY locomotor data") %>%
  kableExtra::kable_material(c("striped", "hover"))
```

## PHQ4

The Patient Health Questionnaire (PHQ-4) data should be changed into an ordered factor.

```{r}
phq4_levels <- c('notatall', 'severaldays', 'morethanhalf', 'nearly')
phq4_labels <- c('not_at_all', 'several_days', 'more_than_half', 'nearly_every_day')

phq4 <- play_merge %>%
  dplyr::select(
    .,
    age_group,
    child_sex,
    health.phq4.phq4_nervous,
    health.phq4.phq4_worrying,
    health.phq4.phq4_littleinterest,
    health.phq4.phq4_down
  ) %>%
  dplyr::rename(
    .,
    nervous = health.phq4.phq4_nervous,
    worrying = health.phq4.phq4_worrying,
    little_interest = health.phq4.phq4_littleinterest,
    down = health.phq4.phq4_down
  ) %>%
  dplyr::mutate(
    .,
    nervous = factor(
      nervous,
      levels = phq4_levels,
      labels = phq4_labels,
      ordered = TRUE
    ),
    worrying = factor(
      worrying,
      levels = phq4_levels,
      labels = phq4_labels,
      ordered = TRUE
    ),
    little_interest = factor(
      little_interest,
      levels = phq4_levels,
      labels = phq4_labels,
      ordered = TRUE
    ),
    down = factor(
      down,
      levels = phq4_levels,
      labels = phq4_labels,
      ordered = TRUE
    )
  )
```

> "*Over the last two weeks, how often have you been bothered by the following problems?*"

### "Nervous"

> "*...Feeling nervous, anxious, or on edge*"

```{r}
l_nervous <- likert::likert(as.data.frame(phq4$nervous))
plot(l_nervous)
```

### "Worrying"

> "...Not being able to stop or control worrying"

```{r}
l_worrying <- likert::likert(as.data.frame(phq4$worrying))
plot(l_worrying)
```

### "Little interest"

> "...Little interest or pleasure in doing things"

```{r}
l_little_interest <- likert::likert(as.data.frame(phq4$little_interest))
plot(l_little_interest)
```

### "Down"

> "*...Feeling down, depressed, or hopeless*"

```{r}
l_down <- likert::likert(as.data.frame(phq4$down))
plot(l_down)
```

## Health

### Feeding

```{r}
feeding <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group_name, databrary_url,
                health.feeding_nutrition.breastfeed,
                health.feeding_nutrition.solidfood_age) %>%
  dplyr::rename(., breastfeed = health.feeding_nutrition.breastfeed,
                solid_food_mos = health.feeding_nutrition.solidfood_age)
```

```{r}
xtabs(formula = ~ child_sex + breastfeed, data = feeding)
```

```{r}
feeding %>%
  ggplot(.) +
  aes(x = solid_food_mos, color = child_sex, fill = child_sex) +
  geom_histogram()
```

### Smoking/drinking

```{r}
smoking_drinking <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group_name, databrary_url,
                health.smoking.pregnant_smoking,
                health.drinking.pregnant_drinking) %>%
  dplyr::rename(., preg_smoking = health.smoking.pregnant_smoking,
                preg_drinking = health.drinking.pregnant_drinking)

xtabs(formula = ~ preg_smoking + preg_drinking, smoking_drinking)
```

### Sleeping position

```{r}
sleeping_pos <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group_name, databrary_url,
                health.general_health.child_sleeping_position ) %>%
  dplyr::rename(., child_sleeping_position = health.general_health.child_sleeping_position) 

xtabs(formula = ~ child_sleeping_position, data = sleeping_pos)
```

### Child health rating

```{r}
child_health <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group_name, databrary_url,
                health.general_health.child_health ) %>%
  dplyr::rename(., child_health_rating = health.general_health.child_health) %>%
  dplyr::mutate(., child_health_rating = factor(child_health_rating, levels = c('good', 'verygood', 'excellent'), ordered = TRUE))


plot(likert::likert(as.data.frame(child_health$child_health_rating)))
```

### See medical specialist

```{r}
med_specialist <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group_name, databrary_url,
                health.general_health.child_medical_specialist,
                health.general_health.comments_child_medical_special) %>%
  dplyr::rename(., see_med_specialist = health.general_health.child_medical_specialist,
                med_specialist_reason = health.general_health.comments_child_medical_special)

xtabs(formula = ~ age_group + see_med_specialist, data = med_specialist)
```

#### Med specialist reasons

```{r}
med_specialist %>%
  dplyr::filter(., (!is.na(med_specialist_reason))) %>%
  dplyr::select(., med_specialist_reason)
```

### Vaccination status

```{r}
vaccination <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group_name, databrary_url,
                health.general_health.child_vaccination ) %>%  
  dplyr::rename(., child_vaccinated_last_4wks = health.general_health.child_vaccination )

xtabs(formula = ~ age_group + child_vaccinated_last_4wks, data = vaccination)
```

### Vision/Hearing screen

```{r}
play_vis_aud <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group_name, databrary_url,
                health.general_health.child_vision_tested,
                health.general_health.child_hearing_tested) %>%
  dplyr::rename(., vision_tested = health.general_health.child_vision_tested,
                hearing_tested = health.general_health.child_hearing_tested)
```

```{r}
xtabs(formula = ~ age_group + vision_tested, data = play_vis_aud)
```

```{r}
xtabs(formula = ~ age_group + hearing_tested, data = play_vis_aud)
```

## Media use

```{r}
media_use_cols <- stringr::str_detect(names(play_merge), 'mediause')
media_use_col_index <- (1:length(names(play_merge)))[media_use_cols]

media_use <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group_name, databrary_url,
                all_of(media_use_col_index)) %>%
  dplyr::rename(., have_tv =  mediause.home_technology.tv,
                have_dvd = mediause.home_technology.dvd,
                have_computer = mediause.home_technology.computer,
                have_tablet = mediause.home_technology.ipad,
                have_videogame = mediause.home_technology.videogame,
                have_educationalgame = mediause.home_technology.educationalgame,
                child_use_tv = mediause.technology_child_tv,
                child_use_tv_how = mediause.tv_how,
                child_use_dvd = mediause.technology_child_dvd,
                child_use_dvd_how = mediause.dvd_how,
                child_use_computer = mediause.technology_child_computer,
                child_use_computer_how = mediause.computer_how,
                child_use_tablet = mediause.technology_child_ipad,
                child_use_tablet_how = mediause.ipad_how,
                child_use_edugame = mediause.technology_child_educational,
                child_use_edugame_how = mediause.educational_how,
                child_use_videogame = mediause.technology_child_videogame,
                child_use_videogame_how = mediause.videogame_how)
```

### Media at home

```{r}
xtabs(formula = ~ have_tv, data = media_use)
xtabs(formula = ~ have_dvd, data = media_use)
xtabs(formula = ~ have_computer, data = media_use)
#xtabs(formula = ~ mediause.home_technology.smartphone, data = media_use)
xtabs(formula = ~  have_tablet, data = media_use)
xtabs(formula = ~  have_videogame, data = media_use)
xtabs(formula = ~ have_educationalgame, data = media_use)
```

**Note**: The KoBoToolbox export does not generate a column for `smartphone` even though that is one of the permitted values in `mediause.home_technology`. We can generate that *post hoc*, however.

```{r}
media_use$mediause.home_technology
```

### Used by child

```{r}
xtabs(formula = ~ age_group + child_use_tv, data = media_use)  
xtabs(formula = ~ age_group + child_use_dvd, data = media_use) 
xtabs(formula = ~ age_group + child_use_computer, data = media_use) 
xtabs(formula = ~ age_group + child_use_tablet, data = media_use) 
xtabs(formula = ~ age_group + child_use_edugame, data = media_use) 
xtabs(formula = ~ age_group + child_use_videogame, data = media_use)
```


## Pets

```{r}
pets <- play_merge %>%
  dplyr::select(., age_group, child_sex, language_child, group_name, databrary_url,
                pets.pets_at_home,
                pets.pets_types_number,
                pets.pets_indoors_outdoors,
                pets.comments_pets) %>%
  dplyr::rename(., pets_at_home = pets.pets_at_home,
                pets_where_live = pets.pets_indoors_outdoors) %>%
  dplyr::mutate(., have_dog = stringr::str_detect(pets.pets_types_number, '[dD]og'),
                have_cat = stringr::str_detect(pets.pets_types_number, '[cC]at'),
                have_bird = stringr::str_detect(pets.pets_types_number, '[bB]ird'),
                have_fish = stringr::str_detect(pets.pets_types_number, '[fF]ish'))
```

```{r}
xtabs(formula = ~ pets_at_home + pets_where_live, data = pets)
```

Focusing on families that *have* pets at home.

```{r}
pets %>%
  dplyr::filter(., pets_at_home == "yes") %>%
  dplyr::select(., pets_at_home, have_dog, have_cat, have_bird, have_fish)
```

